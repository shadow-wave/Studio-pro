<!DOCTYPE html>
<html lang="en" class="dark"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6ImJlMDcyNWEwZmIxZWZmN2I5N2MyNDEwY2U0Nzc1YmM5MGY1MWFiYTUiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIwNzUwMTE3OTcwMjAzMTEzNzcxMyIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJkMGY4YzAwODZmZmYtaW5kZXguaHRtbC00NDYifSwiZXhwIjoxNzcyMjk5NjM2LCJpYXQiOjE3NzIyOTYwMzYsImFsZyI6IlJTMjU2In0.ZMDK1REoeVjbD1JczESxi56KHyabJ1KAH20gcw4bkVPR5zNMD5j0zmRNTFjSFAQJyU4opr-VumaEBb449uEK8EMtcjbND-3Ybp4P29F8HrDPkybm9gDFrh5L9l9hYQlLN-tHbvVbmOVnGip5qvki4UY2JK714BycRLLXbweJS78LBhSICZDRxSV4Cg4cfypUBgyPnKLdJFbg4VPcnAmIJ49rBukHcGx-3eabVotyCXouxVvCmbGtJRwQnVv0cSV0z9oMk39qySRBkt5WafMBXuGNtCyCKcuqBidlxbVR17jYga7_7csgW87SlTp5JgR2NgCJCP47BpLS0iGWGtvLdw","d0f8c0086fff-index.html-446")</script><script>(function(){'use strict';var h=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var n=l(this);
function p(a,b){if(b)a:{var d=n;a=a.split(".");for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in d))break a;d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&b!=null&&h(d,a,{configurable:!0,writable:!0,value:b})}}function r(a){function b(c){return a.next(c)}function d(c){return a.throw(c)}return new Promise(function(c,e){function f(g){g.done?c(g.value):Promise.resolve(g.value).then(b,d).then(f,e)}f(a.next())})}function t(a){return r(a())}
p("Object.values",function(a){return a?a:function(b){var d=[],c;for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&d.push(b[c]);return d}});p("Array.prototype.includes",function(a){return a?a:function(b,d){var c=this;c instanceof String&&(c=String(c));var e=c.length;d=d||0;for(d<0&&(d=Math.max(d+e,0));d<e;d++){var f=c[d];if(f===b||Object.is(f,b))return!0}return!1}});/*

 MIT License

 Copyright (c) 2017-2023 W.Y.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.

*/
function u(a,b){const d=a.style;b.backgroundColor&&(d.backgroundColor=b.backgroundColor);b.width&&(d.width=`${b.width}px`);b.height&&(d.height=`${b.height}px`);const c=b.style;c!=null&&Object.keys(c).forEach(e=>{d[e]=c[e]})};var v=(()=>{let a=0;return()=>{a+=1;return`u${`0000${(Math.random()*1679616<<0).toString(36)}`.slice(-4)}${a}`}})();function w(a){const b=[];for(let d=0,c=a.length;d<c;d++)b.push(a[d]);return b}let x=null;function y(a={}){return x?x:a.l?x=a.l:x=w(window.getComputedStyle(document.documentElement))}function z(a,b){return(a=(a.ownerDocument.defaultView||window).getComputedStyle(a).getPropertyValue(b))?parseFloat(a.replace("px","")):0}
function A(a,b={}){var d;if(!(d=b.width)){d=z(a,"border-left-width");var c=z(a,"border-right-width");d=a.clientWidth+d+c}(b=b.height)||(b=z(a,"border-top-width"),c=z(a,"border-bottom-width"),b=a.clientHeight+b+c);return{width:d,height:b}}function B(a){return new Promise((b,d)=>{const c=new Image;c.onload=()=>{c.decode().then(()=>{requestAnimationFrame(()=>b(c))})};c.onerror=d;c.crossOrigin="anonymous";c.decoding="async";c.src=a})}
function C(a){return t(function*(){return Promise.resolve().then(()=>(new XMLSerializer).serializeToString(a)).then(encodeURIComponent).then(b=>`data:image/svg+xml;charset=utf-8,${b}`)})}
function D(a,b,d){return t(function*(){const c=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");c.setAttribute("width",`${b}`);c.setAttribute("height",`${d}`);c.setAttribute("viewBox",`0 0 ${b} ${d}`);e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("x","0");e.setAttribute("y","0");e.setAttribute("externalResourcesRequired","true");c.appendChild(e);e.appendChild(a);return C(c)})}
var E=(a,b)=>{if(a instanceof b)return!0;a=Object.getPrototypeOf(a);return a===null?!1:a.constructor.name===b.name||E(a,b)};function F(a,b){return y(b).map(d=>{const c=a.getPropertyValue(d),e=a.getPropertyPriority(d);return`${d}: ${c}${e?" !important":""};`}).join(" ")}
function G(a,b,d,c){a=window.getComputedStyle(a,d);var e=a.getPropertyValue("content");if(e!==""&&e!=="none"){var f=v();try{b.className=`${b.className} ${f}`}catch(k){return}e=document.createElement("style");var g=e.appendChild;d=`.${f}:${d}`;a.cssText?(c=a.getPropertyValue("content"),c=`${a.cssText} content: '${c.replace(/'|"/g,"")}';`):c=F(a,c);g.call(e,document.createTextNode(`${d}{${c}}`));b.appendChild(e)}};function H(a){return a.search(/^(data:)/)!==-1}function I(a,b,d){return t(function*(){const c=yield fetch(a,b);if(c.status===404)throw Error(`Resource "${c.url}" not found`);const e=yield c.blob();return new Promise((f,g)=>{const k=new FileReader;k.onerror=g;k.onloadend=()=>{try{f(d({o:c,result:k.result}))}catch(m){g(m)}};k.readAsDataURL(e)})})}const J={};function K(a,b,d){let c=a.replace(/\?.*/,"");d&&(c=a);/ttf|otf|eot|woff2?/i.test(c)&&(c=c.replace(/.*\//,""));return b?`[${b}]${c}`:c}
function L(a,b,d){return t(function*(){const c=K(a,b,d.C);if(J[c]!=null)return J[c];d.u&&(a+=(/\?/.test(a)?"&":"?")+(new Date).getTime());let e;try{const f=yield I(a,d.i,({o:g,result:k})=>{b||(b=g.headers.get("Content-Type")||"");return k.split(/,/)[1]});e=`data:${b};base64,${f}`}catch(f){e=d.B||""}return J[c]=e})};const M={P:"application/font-woff",R:"application/font-woff",N:"application/font-truetype",v:"application/vnd.ms-fontobject",H:"image/png",F:"image/jpeg",D:"image/jpeg",A:"image/gif",M:"image/tiff",L:"image/svg+xml",O:"image/webp"};function N(a){return(a=/\.([^./]*?)$/g.exec(a))?a[1]:""};function O(a){return t(function*(){const b=a.toDataURL();return b==="data:,"?a.cloneNode(!1):B(b)})}function aa(a,b){return t(function*(){if(a.currentSrc){var d=document.createElement("canvas");const c=d.getContext("2d");d.width=a.clientWidth;d.height=a.clientHeight;c==null||c.drawImage(a,0,0,d.width,d.height);d=d.toDataURL();return B(d)}d=a.poster;d=yield L(d,M[N(d).toLowerCase()]||"",b);return B(d)})}
function ba(a,b){return t(function*(){try{let d;if(a==null?0:(d=a.contentDocument)==null?0:d.body)return yield P(a.contentDocument.body,b,!0)}catch(d){}return a.cloneNode(!1)})}function ca(a,b){return t(function*(){return E(a,HTMLCanvasElement)?O(a):E(a,HTMLVideoElement)?aa(a,b):E(a,HTMLIFrameElement)?ba(a,b):a.cloneNode(a.tagName!=null&&a.tagName.toUpperCase()==="SVG")})}
function da(a,b,d){return t(function*(){if(b.tagName!=null&&b.tagName.toUpperCase()==="SVG")return b;let c=[];if(a.tagName!=null&&a.tagName.toUpperCase()==="SLOT"&&a.assignedNodes)c=w(a.assignedNodes());else{let e;if(E(a,HTMLIFrameElement)&&((e=a.contentDocument)==null?0:e.body))c=w(a.contentDocument.body.childNodes);else{let f;c=w(((f=a.shadowRoot)!=null?f:a).childNodes)}}if(c.length===0||E(a,HTMLVideoElement))return b;yield c.reduce((e,f)=>e.then(()=>P(f,d)).then(g=>{g&&b.appendChild(g)}),Promise.resolve());
return b})}function ea(a,b,d){const c=b.style;if(c){var e=window.getComputedStyle(a);e.cssText?(c.cssText=e.cssText,c.transformOrigin=e.transformOrigin):y(d).forEach(f=>{let g=e.getPropertyValue(f);f==="font-size"&&g.endsWith("px")&&(g=`${Math.floor(parseFloat(g.substring(0,g.length-2)))-.1}px`);E(a,HTMLIFrameElement)&&f==="display"&&g==="inline"&&(g="block");f==="d"&&b.getAttribute("d")&&(g=`path(${b.getAttribute("d")})`);c.setProperty(f,g,e.getPropertyPriority(f))})}}
function fa(a,b){E(a,HTMLSelectElement)&&(b=Array.from(b.children).find(d=>a.value===d.getAttribute("value")))&&b.setAttribute("selected","")}
function ha(a,b){return t(function*(){var d=a.querySelectorAll?a.querySelectorAll("use"):[];if(d.length===0)return a;var c={};for(var e=0;e<d.length;e++){var f=d[e].getAttribute("xlink:href");if(f){const g=document.querySelector(f);a.querySelector(f)||!g||c[f]||(c[f]=yield P(g,b,!0))}}d=Object.values(c);if(d.length){c=document.createElementNS("http://www.w3.org/1999/xhtml","svg");c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");c.style.position="absolute";c.style.width="0";c.style.height="0";
c.style.overflow="hidden";c.style.display="none";e=document.createElementNS("http://www.w3.org/1999/xhtml","defs");c.appendChild(e);for(f=0;f<d.length;f++)e.appendChild(d[f]);a.appendChild(c)}return a})}
function P(a,b,d){return t(function*(){return d||!b.filter||b.filter(a)?Promise.resolve(a).then(c=>ca(c,b)).then(c=>da(a,c,b)).then(c=>{E(c,Element)&&(ea(a,c,b),G(a,c,":before",b),G(a,c,":after",b),E(a,HTMLTextAreaElement)&&(c.textContent=a.value),E(a,HTMLInputElement)&&c.setAttribute("value",a.value),fa(a,c));return c}).then(c=>ha(c,b)):null})};const Q=/url\((['"]?)([^'"]+?)\1\)/g,ia=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ja=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ka(a){const b=[];a.replace(Q,(d,c,e)=>{b.push(e);return d});return b.filter(d=>!H(d))}
function la(a,b,d,c){return t(function*(){try{const e=d?(new URL(b,d||void 0)).toString():b;let f;f=yield L(e,M[N(b).toLowerCase()]||"",c);return a.replace(new RegExp(`(url\\(['"]?)(${b.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")})(['"]?\\))`,"g"),`$1${f}$3`)}catch(e){}return a})}function ma(a,{I:b}){return b?a.replace(ja,d=>{for(;;){const [c,,e]=ia.exec(d)||[],f=c,g=e;if(!g)return"";if(g===b)return`src: ${f};`}}):a}
function R(a,b,d){return t(function*(){if(a.search(Q)===-1)return a;const c=ma(a,d);return ka(c).reduce((e,f)=>e.then(g=>la(g,f,b,d)),Promise.resolve(c))})};function S(a,b,d){return t(function*(){var c;const e=(c=b.style)==null?void 0:c.getPropertyValue(a);return e?(c=yield R(e,null,d),b.style.setProperty(a,c,b.style.getPropertyPriority(a)),!0):!1})}function na(a,b){return t(function*(){(yield S("background",a,b))||(yield S("background-image",a,b));(yield S("mask",a,b))||(yield S("-webkit-mask",a,b))||(yield S("mask-image",a,b))||(yield S("-webkit-mask-image",a,b))})}
function oa(a,b){return t(function*(){const d=E(a,HTMLImageElement);if(d&&!H(a.src)||E(a,SVGImageElement)&&!H(a.href.baseVal)){var c=d?a.src:a.href.baseVal,e=yield L(c,M[N(c).toLowerCase()]||"",b);yield new Promise((f,g)=>{a.onload=f;a.onerror=b.m?(...k)=>{try{f(b.m(...k))}catch(m){g(m)}}:g;a.decode&&(a.decode=f);a.loading==="lazy"&&(a.loading="eager");d?(a.srcset="",a.src=e):a.href.baseVal=e})}})}
function pa(a,b){return t(function*(){const d=w(a.childNodes).map(c=>T(c,b));yield Promise.all(d).then(()=>a)})}function T(a,b){return t(function*(){E(a,Element)&&(yield na(a,b),yield oa(a,b),yield pa(a,b))})};const U={};function V(a){return t(function*(){var b=U[a];if(b!=null)return b;b=yield(yield fetch(a)).text();b={url:a,cssText:b};return U[a]=b})}function W(a,b){return t(function*(){let d=a.cssText;const c=/url\(["']?([^"')]+)["']?\)/g,e=(d.match(/url\([^)]+\)/g)||[]).map(f=>t(function*(){let g=f.replace(c,"$1");g.startsWith("https://")||(g=(new URL(g,a.url)).href);return I(g,b.i,({result:k})=>{d=d.replace(f,`url(${k})`);return[f,k]})}));return Promise.all(e).then(()=>d)})}
function X(a){if(a==null)return[];const b=[];a=a.replace(/(\/\*[\s\S]*?\*\/)/gi,"");for(var d=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");;){var c=d.exec(a);if(c===null)break;b.push(c[0])}a=a.replace(d,"");d=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi;for(c=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");;){let e=d.exec(a);if(e===null)if(e=c.exec(a),e===null)break;else d.lastIndex=c.lastIndex;else c.lastIndex=
d.lastIndex;b.push(e[0])}return b}
function qa(a,b){return t(function*(){const d=[],c=[];a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach((f,g)=>{if(f.type===CSSRule.IMPORT_RULE){let k=g+1;f=V(f.href).then(m=>W(m,b)).then(m=>X(m).forEach(q=>{try{e.insertRule(q,q.startsWith("@import")?k+=1:e.cssRules.length)}catch(Da){}})).catch(()=>{});c.push(f)}})}catch(f){const g=a.find(k=>k.href==null)||document.styleSheets[0];e.href!=null&&c.push(V(e.href).then(k=>W(k,b)).then(k=>X(k).forEach(m=>{g.insertRule(m,g.cssRules.length)})).catch(()=>
{}))}});return Promise.all(c).then(()=>{a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach(f=>{d.push(f)})}catch(f){}});return d})})}function ra(a){return a.filter(b=>b.type===CSSRule.FONT_FACE_RULE).filter(b=>b.style.getPropertyValue("src").search(Q)!==-1)}function sa(a,b){return t(function*(){if(a.ownerDocument==null)throw Error("Provided element is not within a Document");var d=w(a.ownerDocument.styleSheets);d=yield qa(d,b);return ra(d)})}
function ta(a){function b(c){(c.style.fontFamily||getComputedStyle(c).fontFamily).split(",").forEach(e=>{d.add(e.trim().replace(/["']/g,""))});Array.from(c.children).forEach(e=>{e instanceof HTMLElement&&b(e)})}const d=new Set;b(a);return d}function ua(a,b){return t(function*(){const d=yield sa(a,b),c=ta(a);return(yield Promise.all(d.filter(e=>c.has(e.style.fontFamily.trim().replace(/["']/g,""))).map(e=>R(e.cssText,e.parentStyleSheet?e.parentStyleSheet.href:null,b)))).join("\n")})}
function va(a,b){return t(function*(){const d=b.j!=null?b.j:b.K?null:yield ua(a,b);if(d){const c=document.createElement("style");c.appendChild(document.createTextNode(d));a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)}})};function wa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b),e=yield P(a,b,!0);yield va(e,b);yield T(e,b);u(e,b);return yield D(e,d,c)})}
function xa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b);var e=yield wa(a,b);e=yield B(e);const f=document.createElement("canvas"),g=f.getContext("2d"),k=b.G||window.devicePixelRatio||1,m=b.h||d,q=b.g||c;f.width=m*k;f.height=q*k;!b.J&&(f.width>16384||f.height>16384)&&(f.width>16384&&f.height>16384?f.width>f.height?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=16384):f.width>16384?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=
16384));f.style.width=`${m}`;f.style.height=`${q}`;b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,f.width,f.height));g.drawImage(e,0,0,f.width,f.height);return f})}function ya(a,b={}){return t(function*(){return(yield xa(a,b)).toDataURL()})};const za=["gemini.google.com","corp.google.com","proxy.googlers.com"];function Y(){return document.body.querySelectorAll('[class*="animate"]').length>0}function Z(a){return t(function*(){try{return yield ya(a,{h:a.offsetWidth,g:a.offsetHeight})}catch(d){var b=a.offsetHeight;const c=document.createElement("canvas");c.width=a.offsetWidth;c.height=b;return c.toDataURL("image/png")}})}
function Aa(){return t(function*(){const a=document.body.offsetWidth,b=document.body.offsetHeight,d=document.body.cloneNode(!0);d.querySelectorAll('[class*="animate"]').forEach(c=>{c.classList.remove(...Array.from(c.classList).filter(e=>e.startsWith("animate")))});d.style.width=`${a}px`;d.style.height=`${b}px`;return d})}
function Ba(a){return t(function*(){let b=document.body;if(Y()){var d=yield Aa();b=d;document.body.appendChild(d)}d=yield Z(b);Y()&&document.body.removeChild(b);window.parent.postMessage({type:"SEND_SCREENSHOT",image:d,topOffset:document.documentElement.scrollTop},a.origin)})}function Ca(a){return t(function*(){const b={type:"SEND_SCREENSHOT_FOR_DATA_VISUALIZATION",image:yield Z(document.body),topOffset:0};window.parent.postMessage(b,a.origin)})}
window.addEventListener("message",a=>t(function*(){if(za.some(d=>a.origin.includes(d))){var b=a.data;b&&(b.type==="MAKE_SCREENSHOT"&&(yield Ba(a)),b.type==="MAKE_SCREENSHOT_FOR_DATA_VISUALIZATION"&&(yield Ca(a)))}}));
})();</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageTransformModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });
  modelInformation.deprecatedImageModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predict',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predictLongRunning',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash","imageModelName":"imagen-4.0-generate-001","imageEditModelName":"gemini-2.5-flash-image-preview","imageTransformModelName":"gemini-3-pro-image-preview-11-2025","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20","gemini-2.5-flash-preview-09-2025"],"deprecatedImageModelNames":["imagen-3.0-generate-001","imagen-3.0-generate-002"]})</script><script>(function(){'use strict';function a(){window.parent.postMessage({type:"interaction"},"*")}window.addEventListener("click",a,{capture:!0,passive:!0});window.addEventListener("touchstart",a,{capture:!0,passive:!0});window.addEventListener("keydown",a,{capture:!0,passive:!0});}).call(this);
</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Studio Pro - Ultimate Mobile Editor</title>
    
    <!-- Initialize tailwind config before loading the CDN -->
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { ios: { blue: '#0A84FF', glass: 'rgba(30, 30, 35, 0.65)', border: 'rgba(255, 255, 255, 0.15)' } },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    animation: { 
                        'blob': 'blob 15s infinite alternate cubic-bezier(0.4, 0, 0.2, 1)', 
                        'blob-reverse': 'blob 18s infinite alternate-reverse cubic-bezier(0.4, 0, 0.2, 1)',
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards'
                    },
                    keyframes: { 
                        blob: { 
                            '0%': { transform: 'translate(0px, 0px) scale(1)' }, 
                            '50%': { transform: 'translate(20px, -30px) scale(1.05)' },
                            '100%': { transform: 'translate(-10px, 20px) scale(0.95)' } 
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px) scale(0.98)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' }
                        }
                    }
                }
            }
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Premium Font Library (Expanded) -->
    <link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&amp;family=Anek+Malayalam:wght@400;700;800;900&amp;family=Anton&amp;family=Bungee&amp;family=Baloo+Chettan+2:wght@700;800&amp;family=Bebas+Neue&amp;family=Caveat:wght@700&amp;family=Chilanka&amp;family=Cinzel:wght@700;900&amp;family=Dancing+Script:wght@700&amp;family=Gayathri:wght@700&amp;family=Impact&amp;family=Inter:wght@400;500;600;700;900&amp;family=Lato:wght@400;700;900&amp;family=Lobster&amp;family=Manjari:wght@700&amp;family=Meera+Inimai&amp;family=Merriweather:ital,wght@0,700;1,700&amp;family=Mina:wght@700&amp;family=Montserrat:wght@400;700;900&amp;family=Mukta+Malar:wght@700&amp;family=Noto+Sans+Malayalam:wght@700;900&amp;family=Noto+Serif+Malayalam:wght@700&amp;family=Open+Sans:wght@700&amp;family=Oswald:wght@500;700&amp;family=Pacifico&amp;family=Permanent+Marker&amp;family=Playfair+Display:ital,wght@0,700;1,700&amp;family=Poppins:wght@400;500;600;800;900&amp;family=Raleway:wght@700;900&amp;family=Righteous&amp;family=Roboto:wght@700;900&amp;family=Space+Grotesk:wght@700&amp;family=Syne:wght@700;800&amp;display=swap" rel="stylesheet">
    
    <style>
        /* Apple Bouncy Physics & Mobile Optimizations */
        :root { 
            --apple-spring: cubic-bezier(0.25, 1, 0.4, 1); 
            --apple-ease: cubic-bezier(0.32, 0.72, 0, 1);
        }
        
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000000; color: #ffffff; overscroll-behavior-y: none; -webkit-font-smoothing: antialiased; touch-action: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; outline: none; }
        
        /* Smooth scrolling for panels without pulling the page */
        .scroll-panel { overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; touch-action: pan-y; }

        /* VisionOS Liquid Glass Components */
        .glass-pill {
            background: rgba(20, 20, 25, 0.65); backdrop-filter: blur(40px) saturate(200%); -webkit-backdrop-filter: blur(40px) saturate(200%);
            border-top: 1px solid rgba(255, 255, 255, 0.25); border-bottom: 1px solid rgba(0, 0, 0, 0.6);
            border-left: 1px solid rgba(255, 255, 255, 0.1); border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4), inset 0 1px 1px rgba(255, 255, 255, 0.2);
            will-change: transform; transform: translateZ(0);
        }
        .glass-sheet {
            background: rgba(18, 18, 22, 0.85); backdrop-filter: blur(50px) saturate(200%); -webkit-backdrop-filter: blur(50px) saturate(200%);
            border-top: 1px solid rgba(255, 255, 255, 0.2); border-left: 1px solid rgba(255, 255, 255, 0.1); border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.8), inset 0 1px 2px rgba(255, 255, 255, 0.15);
            border-top-left-radius: 2.5rem; border-top-right-radius: 2.5rem; transform: translateZ(0);
        }
        .glass-module { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05), 0 4px 10px rgba(0,0,0,0.2); border-radius: 1.5rem; }
        
        /* Touch Optimized Buttons */
        .btn-press { transition: transform 0.15s var(--apple-spring), opacity 0.15s, background-color 0.2s; cursor: pointer; user-select: none; touch-action: manipulation; }
        @media (hover: hover) { .btn-press:hover { transform: scale(1.03); } }
        .btn-press:active { transform: scale(0.92); opacity: 0.8; transition: none; }
        
        .tool-card {
            background: linear-gradient(160deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.15); border-bottom: 1px solid rgba(0, 0, 0, 0.4);
            border-left: 1px solid rgba(255, 255, 255, 0.05); border-right: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 8px 15px rgba(0,0,0,0.2);
            border-radius: 1.25rem; transition: transform 0.2s var(--apple-spring), background 0.2s; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; touch-action: manipulation;
        }
        .tool-card:active { transform: scale(0.95); background: rgba(255,255,255,0.15); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: none; }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.4); border-top: 1px solid rgba(0, 0, 0, 0.6); border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6); color: white; border-radius: 1.2rem; outline: none; transition: border 0.3s;
            -webkit-appearance: none; appearance: none;
        }
        .glass-input:focus { border-color: rgba(10, 132, 255, 0.8); background: rgba(10, 132, 255, 0.15); }

        /* Accordions */
        .accordion-btn { transition: background 0.2s var(--apple-ease), transform 0.15s; border: 1px solid rgba(255,255,255,0.05); touch-action: manipulation; }
        .accordion-btn:active { transform: scale(0.97); background: rgba(255,255,255,0.12); transition: none; }
        .accordion-content { animation: expandDown 0.3s var(--apple-spring); transform-origin: top; }
        @keyframes expandDown { from { opacity: 0; transform: scaleY(0.97) translateY(-5px); } to { opacity: 1; transform: scaleY(1) translateY(0); } }

        /* Canvas Environment */
        .ambient-bg { position: absolute; inset: 0; z-index: -1; overflow: hidden; pointer-events: none; background: #000000; }
        .canvas-container-wrap { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 0; touch-action: none; background-image: radial-gradient(rgba(255,255,255,0.08) 1px, transparent 1px); background-size: 24px 24px; }
        .canvas-elevation { box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 40px 80px -20px rgba(0,0,0,1); transition: transform 0.1s linear; background-color: #ffffff; border-radius: 2px; transform-origin: center center; }

        /* Bottom Sheets */
        .sheet { position: absolute; bottom: 0; left: 0; right: 0; transform: translateY(100%); transition: transform 0.4s var(--apple-spring); z-index: 50; max-height: 85dvh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom); will-change: transform; }
        .sheet.open { transform: translateY(0); }
        .sheet-drag-area { width: 100%; padding: 16px 0; display: flex; justify-content: center; align-items: center; cursor: grab; touch-action: pan-y; }
        .sheet-drag-area:active { cursor: grabbing; }
        .sheet-grabber { width: 45px; height: 5px; background: rgba(255,255,255,0.4); border-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        /* Dock Icons */
        .dock-icon { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; color: rgba(255,255,255,0.45); transition: all 0.2s; cursor: pointer; touch-action: manipulation; }
        .dock-icon.active { color: #ffffff; transform: translateY(-4px); }
        .dock-icon.active i { color: #0a84ff; filter: drop-shadow(0 0 8px rgba(10, 132, 255, 0.6)); transform: scale(1.05); }
        .dock-icon i { font-size: 22px; transition: transform 0.2s; }
        .dock-icon span { font-size: 10px; font-weight: 700; letter-spacing: 0.5px; opacity: 0; transform: translateY(4px); transition: all 0.2s; }
        .dock-icon.active span { opacity: 1; transform: translateY(0); }
        
        .tool-card-content { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 16px 8px; cursor: pointer; transition: transform 0.15s, background 0.2s; border: 1px solid rgba(255,255,255,0.08); touch-action: manipulation; }
        .tool-card-content:active { transform: scale(0.94); background-color: rgba(255,255,255,0.15); transition: none; }
        
        .prop-section { display: none; padding: 16px; animation: scaleFadeIn 0.3s var(--apple-ease); }
        .prop-section.active { display: block; }
        @keyframes scaleFadeIn { from { opacity: 0; transform: scale(0.98) translateY(5px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* OS Inputs */
        input[type="color"] { -webkit-appearance: none; border: none; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; padding: 0; overflow: hidden; box-shadow: 0 0 0 2px rgba(255,255,255,0.15), 0 4px 10px rgba(0,0,0,0.4); background: transparent; transition: transform 0.15s; }
        input[type="color"]:active { transform: scale(0.85); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        
        input[type="range"] { -webkit-appearance: none; background: rgba(255,255,255,0.15); height: 12px; border-radius: 6px; outline: none; box-shadow: inset 0 1px 4px rgba(0,0,0,0.4); width: 100%; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 32px; height: 32px; border-radius: 50%; background: #ffffff; box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 -2px 4px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s; }
        input[type="range"]::-webkit-slider-thumb:active { transform: scale(1.15); }
        
        .segment-control { display: flex; background: rgba(0,0,0,0.5); border-radius: 14px; padding: 4px; border-top: 1px solid rgba(0,0,0,0.6); border-bottom: 1px solid rgba(255,255,255,0.1); box-shadow: inset 0 2px 6px rgba(0,0,0,0.4); }
        .segment-btn { flex: 1; padding: 12px 0; text-align: center; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.5); border-radius: 10px; transition: all 0.2s; cursor: pointer; touch-action: manipulation; }
        .segment-btn.active { background: rgba(255,255,255,0.2); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2), inset 0 1px 1px rgba(255,255,255,0.3); }

        .quick-color-btn { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; transition: transform 0.2s var(--apple-spring); flex-shrink: 0;}
        .quick-color-btn:active { transform: scale(0.8); }

        .f-oswald { font-family: 'Oswald', sans-serif; }
        .f-malayalam { font-family: 'Anek Malayalam', sans-serif; }
        
        /* Modals & Toasts */
        #toast { transition: opacity 0.3s, transform 0.4s var(--apple-spring); pointer-events: none; z-index: 9999; opacity: 0; transform: translate(-50%, -20px) scale(0.9); }
        #toast.show { opacity: 1; transform: translate(-50%, 0) scale(1); }
        
        #clearModal { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        #clearModal.show { opacity: 1; pointer-events: auto; }
        #clearModal .glass-sheet { opacity: 0; transform: scale(0.9) translateY(20px); transition: all 0.4s var(--apple-spring); }
        #clearModal.show .glass-sheet { opacity: 1; transform: scale(1) translateY(0); }

        #infoModal { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        #infoModal.show { opacity: 1; pointer-events: auto; }
        #infoModal .glass-sheet { opacity: 0; transform: scale(0.9) translateY(20px); transition: all 0.4s var(--apple-spring); }
        #infoModal.show .glass-sheet { opacity: 1; transform: scale(1) translateY(0); }
    </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.pointer-events-none{pointer-events:none}.pointer-events-auto{pointer-events:auto}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{inset:0px}.bottom-0{bottom:0px}.bottom-6{bottom:1.5rem}.bottom-\[-10\%\]{bottom:-10%}.bottom-\[-20\%\]{bottom:-20%}.bottom-\[20\%\]{bottom:20%}.left-0{left:0px}.left-1\/2{left:50%}.left-\[-10\%\]{left:-10%}.left-\[-20\%\]{left:-20%}.left-\[20\%\]{left:20%}.right-0{right:0px}.right-5{right:1.25rem}.right-\[-10\%\]{right:-10%}.right-\[-20\%\]{right:-20%}.right-\[20\%\]{right:20%}.top-0{top:0px}.top-12{top:3rem}.top-5{top:1.25rem}.top-\[-10\%\]{top:-10%}.top-\[-20\%\]{top:-20%}.top-\[10\%\]{top:10%}.top-\[30\%\]{top:30%}.z-10{z-index:10}.z-20{z-index:20}.z-30{z-index:30}.z-\[100\]{z-index:100}.col-span-2{grid-column:span 2 / span 2}.col-span-full{grid-column:1 / -1}.mx-1{margin-left:0.25rem;margin-right:0.25rem}.mx-auto{margin-left:auto;margin-right:auto}.my-2{margin-top:0.5rem;margin-bottom:0.5rem}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mb-\[env\(safe-area-inset-bottom\)\]{margin-bottom:env(safe-area-inset-bottom)}.ml-1{margin-left:0.25rem}.ml-2{margin-left:0.5rem}.ml-3{margin-left:0.75rem}.mr-3{margin-right:0.75rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-10{height:2.5rem}.h-14{height:3.5rem}.h-16{height:4rem}.h-20{height:5rem}.h-24{height:6rem}.h-32{height:8rem}.h-5{height:1.25rem}.h-8{height:2rem}.h-\[60vw\]{height:60vw}.h-\[80vw\]{height:80vw}.h-\[90vw\]{height:90vw}.h-full{height:100%}.w-10{width:2.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-20{width:5rem}.w-24{width:6rem}.w-32{width:8rem}.w-4{width:1rem}.w-8{width:2rem}.w-80{width:20rem}.w-\[1px\]{width:1px}.w-\[60vw\]{width:60vw}.w-\[80vw\]{width:80vw}.w-\[90\%\]{width:90%}.w-\[90vw\]{width:90vw}.w-full{width:100%}.min-w-\[3rem\]{min-width:3rem}.min-w-max{min-width:max-content}.max-w-\[90vw\]{max-width:90vw}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-1{flex:1 1 0%}.flex-shrink-0{flex-shrink:0}.origin-top-left{transform-origin:top left}.origin-top-right{transform-origin:top right}.-translate-x-1\/2{--tw-translate-x:-50%;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.-rotate-90{--tw-rotate:-90deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.rotate-180{--tw-rotate:180deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.rotate-45{--tw-rotate:45deg;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.scale-\[0\.85\]{--tw-scale-x:0.85;--tw-scale-y:0.85;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-not-allowed{cursor:not-allowed}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.grid-cols-5{grid-template-columns:repeat(5, minmax(0, 1fr))}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.justify-around{justify-content:space-around}.gap-0\.5{gap:0.125rem}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-5{gap:1.25rem}.gap-6{gap:1.5rem}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.rounded-2xl{border-radius:1rem}.rounded-3xl{border-radius:1.5rem}.rounded-\[1\.4rem\]{border-radius:1.4rem}.rounded-\[1\.5rem\]{border-radius:1.5rem}.rounded-\[2\.5rem\]{border-radius:2.5rem}.rounded-full{border-radius:9999px}.rounded-xl{border-radius:0.75rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-t{border-top-width:1px}.border-black\/5{border-color:rgb(0 0 0 / 0.05)}.border-blue-500\/30{border-color:rgb(59 130 246 / 0.3)}.border-cyan-500\/30{border-color:rgb(6 182 212 / 0.3)}.border-emerald-500\/30{border-color:rgb(16 185 129 / 0.3)}.border-green-500\/30{border-color:rgb(34 197 94 / 0.3)}.border-indigo-500\/30{border-color:rgb(99 102 241 / 0.3)}.border-orange-500\/30{border-color:rgb(249 115 22 / 0.3)}.border-pink-500\/30{border-color:rgb(236 72 153 / 0.3)}.border-purple-500\/30{border-color:rgb(168 85 247 / 0.3)}.border-red-500\/30{border-color:rgb(239 68 68 / 0.3)}.border-teal-500\/30{border-color:rgb(20 184 166 / 0.3)}.border-white\/10{border-color:rgb(255 255 255 / 0.1)}.border-white\/20{border-color:rgb(255 255 255 / 0.2)}.border-white\/30{border-color:rgb(255 255 255 / 0.3)}.border-white\/5{border-color:rgb(255 255 255 / 0.05)}.border-yellow-500\/30{border-color:rgb(234 179 8 / 0.3)}.bg-\[\#1e293b\]{--tw-bg-opacity:1;background-color:rgb(30 41 59 / var(--tw-bg-opacity, 1))}.bg-\[\#22c55e\]{--tw-bg-opacity:1;background-color:rgb(34 197 94 / var(--tw-bg-opacity, 1))}.bg-\[\#3b82f6\]{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-\[\#ec4899\]{--tw-bg-opacity:1;background-color:rgb(236 72 153 / var(--tw-bg-opacity, 1))}.bg-\[\#ef4444\]{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-\[\#facc15\]{--tw-bg-opacity:1;background-color:rgb(250 204 21 / var(--tw-bg-opacity, 1))}.bg-amber-500{--tw-bg-opacity:1;background-color:rgb(245 158 11 / var(--tw-bg-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-black\/20{background-color:rgb(0 0 0 / 0.2)}.bg-black\/30{background-color:rgb(0 0 0 / 0.3)}.bg-black\/40{background-color:rgb(0 0 0 / 0.4)}.bg-black\/60{background-color:rgb(0 0 0 / 0.6)}.bg-blue-300{--tw-bg-opacity:1;background-color:rgb(147 197 253 / var(--tw-bg-opacity, 1))}.bg-blue-500{--tw-bg-opacity:1;background-color:rgb(59 130 246 / var(--tw-bg-opacity, 1))}.bg-cyan-950{--tw-bg-opacity:1;background-color:rgb(8 51 68 / var(--tw-bg-opacity, 1))}.bg-emerald-500{--tw-bg-opacity:1;background-color:rgb(16 185 129 / var(--tw-bg-opacity, 1))}.bg-pink-200{--tw-bg-opacity:1;background-color:rgb(251 207 232 / var(--tw-bg-opacity, 1))}.bg-pink-500{--tw-bg-opacity:1;background-color:rgb(236 72 153 / var(--tw-bg-opacity, 1))}.bg-pink-500\/20{background-color:rgb(236 72 153 / 0.2)}.bg-purple-500{--tw-bg-opacity:1;background-color:rgb(168 85 247 / var(--tw-bg-opacity, 1))}.bg-purple-500\/20{background-color:rgb(168 85 247 / 0.2)}.bg-red-500{--tw-bg-opacity:1;background-color:rgb(239 68 68 / var(--tw-bg-opacity, 1))}.bg-red-500\/20{background-color:rgb(239 68 68 / 0.2)}.bg-rose-500{--tw-bg-opacity:1;background-color:rgb(244 63 94 / var(--tw-bg-opacity, 1))}.bg-rose-950{--tw-bg-opacity:1;background-color:rgb(76 5 25 / var(--tw-bg-opacity, 1))}.bg-sky-500{--tw-bg-opacity:1;background-color:rgb(14 165 233 / var(--tw-bg-opacity, 1))}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252 / var(--tw-bg-opacity, 1))}.bg-slate-900{--tw-bg-opacity:1;background-color:rgb(15 23 42 / var(--tw-bg-opacity, 1))}.bg-transparent{background-color:transparent}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-white\/10{background-color:rgb(255 255 255 / 0.1)}.bg-white\/20{background-color:rgb(255 255 255 / 0.2)}.bg-white\/60{background-color:rgb(255 255 255 / 0.6)}.bg-yellow-300{--tw-bg-opacity:1;background-color:rgb(253 224 71 / var(--tw-bg-opacity, 1))}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.bg-gradient-to-tr{background-image:linear-gradient(to top right, var(--tw-gradient-stops))}.from-fuchsia-500\/20{--tw-gradient-from:rgb(217 70 239 / 0.2) var(--tw-gradient-from-position);--tw-gradient-to:rgb(217 70 239 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-green-400{--tw-gradient-from:#4ade80 var(--tw-gradient-from-position);--tw-gradient-to:rgb(74 222 128 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-yellow-500\/20{--tw-gradient-from:rgb(234 179 8 / 0.2) var(--tw-gradient-from-position);--tw-gradient-to:rgb(234 179 8 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.to-emerald-600{--tw-gradient-to:#059669 var(--tw-gradient-to-position)}.to-orange-500\/20{--tw-gradient-to:rgb(249 115 22 / 0.2) var(--tw-gradient-to-position)}.to-pink-500\/20{--tw-gradient-to:rgb(236 72 153 / 0.2) var(--tw-gradient-to-position)}.to-purple-500{--tw-gradient-to:#a855f7 var(--tw-gradient-to-position)}.p-2{padding:0.5rem}.p-3{padding:0.75rem}.p-4{padding:1rem}.p-5{padding:1.25rem}.p-8{padding:2rem}.p-\[2px\]{padding:2px}.px-1{padding-left:0.25rem;padding-right:0.25rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-5{padding-left:1.25rem;padding-right:1.25rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-16{padding-top:4rem;padding-bottom:4rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-4{padding-top:1rem;padding-bottom:1rem}.py-5{padding-top:1.25rem;padding-bottom:1.25rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.pb-1{padding-bottom:0.25rem}.pb-2{padding-bottom:0.5rem}.pb-4{padding-bottom:1rem}.pb-8{padding-bottom:2rem}.pl-1{padding-left:0.25rem}.pl-2{padding-left:0.5rem}.pt-0{padding-top:0px}.pt-3{padding-top:0.75rem}.pt-6{padding-top:1.5rem}.pt-\[calc\(env\(safe-area-inset-top\)\+0\.5rem\)\]{padding-top:calc(env(safe-area-inset-top) + 0.5rem)}.text-left{text-align:left}.text-center{text-align:center}.font-mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-\[10px\]{font-size:10px}.text-\[11px\]{font-size:11px}.text-\[15px\]{font-size:15px}.text-\[9px\]{font-size:9px}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-black{font-weight:900}.font-bold{font-weight:700}.font-normal{font-weight:400}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.italic{font-style:italic}.leading-none{line-height:1}.leading-relaxed{line-height:1.625}.tracking-\[0\.2em\]{letter-spacing:0.2em}.tracking-tight{letter-spacing:-0.025em}.tracking-wide{letter-spacing:0.025em}.tracking-wider{letter-spacing:0.05em}.tracking-widest{letter-spacing:0.1em}.text-\[\#0088cc\]{--tw-text-opacity:1;color:rgb(0 136 204 / var(--tw-text-opacity, 1))}.text-\[\#0a66c2\]{--tw-text-opacity:1;color:rgb(10 102 194 / var(--tw-text-opacity, 1))}.text-\[\#1da1f2\]{--tw-text-opacity:1;color:rgb(29 161 242 / var(--tw-text-opacity, 1))}.text-\[\#1ed760\]{--tw-text-opacity:1;color:rgb(30 215 96 / var(--tw-text-opacity, 1))}.text-\[\#bd081c\]{--tw-text-opacity:1;color:rgb(189 8 28 / var(--tw-text-opacity, 1))}.text-black{--tw-text-opacity:1;color:rgb(0 0 0 / var(--tw-text-opacity, 1))}.text-blue-200{--tw-text-opacity:1;color:rgb(191 219 254 / var(--tw-text-opacity, 1))}.text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-blue-500{--tw-text-opacity:1;color:rgb(59 130 246 / var(--tw-text-opacity, 1))}.text-cyan-200{--tw-text-opacity:1;color:rgb(165 243 252 / var(--tw-text-opacity, 1))}.text-cyan-400{--tw-text-opacity:1;color:rgb(34 211 238 / var(--tw-text-opacity, 1))}.text-emerald-200{--tw-text-opacity:1;color:rgb(167 243 208 / var(--tw-text-opacity, 1))}.text-emerald-400{--tw-text-opacity:1;color:rgb(52 211 153 / var(--tw-text-opacity, 1))}.text-green-200{--tw-text-opacity:1;color:rgb(187 247 208 / var(--tw-text-opacity, 1))}.text-green-400{--tw-text-opacity:1;color:rgb(74 222 128 / var(--tw-text-opacity, 1))}.text-indigo-200{--tw-text-opacity:1;color:rgb(199 210 254 / var(--tw-text-opacity, 1))}.text-indigo-400{--tw-text-opacity:1;color:rgb(129 140 248 / var(--tw-text-opacity, 1))}.text-orange-200{--tw-text-opacity:1;color:rgb(254 215 170 / var(--tw-text-opacity, 1))}.text-orange-400{--tw-text-opacity:1;color:rgb(251 146 60 / var(--tw-text-opacity, 1))}.text-pink-200{--tw-text-opacity:1;color:rgb(251 207 232 / var(--tw-text-opacity, 1))}.text-pink-300{--tw-text-opacity:1;color:rgb(249 168 212 / var(--tw-text-opacity, 1))}.text-pink-400{--tw-text-opacity:1;color:rgb(244 114 182 / var(--tw-text-opacity, 1))}.text-pink-500{--tw-text-opacity:1;color:rgb(236 72 153 / var(--tw-text-opacity, 1))}.text-purple-200{--tw-text-opacity:1;color:rgb(233 213 255 / var(--tw-text-opacity, 1))}.text-purple-300{--tw-text-opacity:1;color:rgb(216 180 254 / var(--tw-text-opacity, 1))}.text-purple-400{--tw-text-opacity:1;color:rgb(192 132 252 / var(--tw-text-opacity, 1))}.text-purple-500{--tw-text-opacity:1;color:rgb(168 85 247 / var(--tw-text-opacity, 1))}.text-red-200{--tw-text-opacity:1;color:rgb(254 202 202 / var(--tw-text-opacity, 1))}.text-red-400{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.text-red-500{--tw-text-opacity:1;color:rgb(239 68 68 / var(--tw-text-opacity, 1))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity, 1))}.text-slate-800{--tw-text-opacity:1;color:rgb(30 41 59 / var(--tw-text-opacity, 1))}.text-teal-200{--tw-text-opacity:1;color:rgb(153 246 228 / var(--tw-text-opacity, 1))}.text-teal-400{--tw-text-opacity:1;color:rgb(45 212 191 / var(--tw-text-opacity, 1))}.text-transparent{color:transparent}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-white\/30{color:rgb(255 255 255 / 0.3)}.text-white\/40{color:rgb(255 255 255 / 0.4)}.text-white\/50{color:rgb(255 255 255 / 0.5)}.text-white\/60{color:rgb(255 255 255 / 0.6)}.text-white\/70{color:rgb(255 255 255 / 0.7)}.text-white\/80{color:rgb(255 255 255 / 0.8)}.text-yellow-200{--tw-text-opacity:1;color:rgb(254 240 138 / var(--tw-text-opacity, 1))}.text-yellow-400{--tw-text-opacity:1;color:rgb(250 204 21 / var(--tw-text-opacity, 1))}.text-yellow-500{--tw-text-opacity:1;color:rgb(234 179 8 / var(--tw-text-opacity, 1))}.opacity-30{opacity:0.3}.opacity-40{opacity:0.4}.opacity-50{opacity:0.5}.opacity-60{opacity:0.6}.opacity-70{opacity:0.7}.opacity-80{opacity:0.8}.mix-blend-screen{mix-blend-mode:screen}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_0_15px_rgba\(255\2c 255\2c 255\2c 0\.3\)\]{--tw-shadow:0 0 15px rgba(255,255,255,0.3);--tw-shadow-colored:0 0 15px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_0_30px_rgba\(239\2c 68\2c 68\2c 0\.4\)\]{--tw-shadow:0 0 30px rgba(239,68,68,0.4);--tw-shadow-colored:0 0 30px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_10px_30px_rgba\(0\2c 0\2c 0\2c 0\.3\)\]{--tw-shadow:0 10px 30px rgba(0,0,0,0.3);--tw-shadow-colored:0 10px 30px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_10px_30px_rgba\(10\2c 132\2c 255\2c 0\.4\)\]{--tw-shadow:0 10px 30px rgba(10,132,255,0.4);--tw-shadow-colored:0 10px 30px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_10px_30px_rgba\(16\2c 185\2c 129\2c 0\.4\)\]{--tw-shadow:0 10px 30px rgba(16,185,129,0.4);--tw-shadow-colored:0 10px 30px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_20px_50px_rgba\(0\2c 0\2c 0\2c 0\.5\)\]{--tw-shadow:0 20px 50px rgba(0,0,0,0.5);--tw-shadow-colored:0 20px 50px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_4px_15px_rgba\(239\2c 68\2c 68\2c 0\.4\)\]{--tw-shadow:0 4px 15px rgba(239,68,68,0.4);--tw-shadow-colored:0 4px 15px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_5px_15px_rgba\(10\2c 132\2c 255\2c 0\.4\)\]{--tw-shadow:0 5px 15px rgba(10,132,255,0.4);--tw-shadow-colored:0 5px 15px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-\[0_5px_15px_rgba\(255\2c 255\2c 255\2c 0\.2\)\]{--tw-shadow:0 5px 15px rgba(255,255,255,0.2);--tw-shadow-colored:0 5px 15px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.blur-\[20px\]{--tw-blur:blur(20px);filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow{--tw-drop-shadow:drop-shadow(0 1px 2px rgb(0 0 0 / 0.1)) drop-shadow(0 1px 1px rgb(0 0 0 / 0.06));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow-\[0_0_15px_rgba\(10\2c 132\2c 255\2c 0\.8\)\]{--tw-drop-shadow:drop-shadow(0 0 15px rgba(10,132,255,0.8));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow-\[0_0_8px_rgba\(10\2c 132\2c 255\2c 0\.5\)\]{--tw-drop-shadow:drop-shadow(0 0 8px rgba(10,132,255,0.5));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow-\[0_0_8px_rgba\(6\2c 182\2c 212\2c 0\.8\)\]{--tw-drop-shadow:drop-shadow(0 0 8px rgba(6,182,212,0.8));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow-\[0_0_8px_rgba\(74\2c 222\2c 128\2c 0\.5\)\]{--tw-drop-shadow:drop-shadow(0 0 8px rgba(74,222,128,0.5));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.drop-shadow-md{--tw-drop-shadow:drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));filter:var(--tw-blur) var(--tw-brightness) var(--tw-contrast) var(--tw-grayscale) var(--tw-hue-rotate) var(--tw-invert) var(--tw-saturate) var(--tw-sepia) var(--tw-drop-shadow)}.backdrop-blur-md{--tw-backdrop-blur:blur(12px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.backdrop-blur-xl{--tw-backdrop-blur:blur(24px);-webkit-backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia);backdrop-filter:var(--tw-backdrop-blur) var(--tw-backdrop-brightness) var(--tw-backdrop-contrast) var(--tw-backdrop-grayscale) var(--tw-backdrop-hue-rotate) var(--tw-backdrop-invert) var(--tw-backdrop-opacity) var(--tw-backdrop-saturate) var(--tw-backdrop-sepia)}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:bg-\[\#334155\]:hover{--tw-bg-opacity:1;background-color:rgb(51 65 85 / var(--tw-bg-opacity, 1))}.hover\:bg-gray-200:hover{--tw-bg-opacity:1;background-color:rgb(229 231 235 / var(--tw-bg-opacity, 1))}.hover\:bg-red-500\/20:hover{background-color:rgb(239 68 68 / 0.2)}.hover\:bg-red-600:hover{--tw-bg-opacity:1;background-color:rgb(220 38 38 / var(--tw-bg-opacity, 1))}.hover\:bg-white\/10:hover{background-color:rgb(255 255 255 / 0.1)}.hover\:bg-white\/20:hover{background-color:rgb(255 255 255 / 0.2)}.hover\:text-red-400:hover{--tw-text-opacity:1;color:rgb(248 113 113 / var(--tw-text-opacity, 1))}.hover\:text-white:hover{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}@media (min-width: 640px){.sm\:col-span-2{grid-column:span 2 / span 2}.sm\:w-auto{width:auto}.sm\:scale-100{--tw-scale-x:1;--tw-scale-y:1;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.sm\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.sm\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.sm\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.sm\:grid-cols-6{grid-template-columns:repeat(6, minmax(0, 1fr))}.sm\:justify-center{justify-content:center}.sm\:gap-1{gap:0.25rem}.sm\:gap-10{gap:2.5rem}.sm\:px-4{padding-left:1rem;padding-right:1rem}.sm\:px-5{padding-left:1.25rem;padding-right:1.25rem}.sm\:px-8{padding-left:2rem;padding-right:2rem}.sm\:text-\[11px\]{font-size:11px}}@media (min-width: 768px){.md\:gap-14{gap:3.5rem}.md\:py-6{padding-top:1.5rem;padding-bottom:1.5rem}}</style></head>
<body>

    <!-- GPU-Optimized Ambient Background -->
    <div class="ambient-bg">
        <div class="absolute top-[-10%] left-[-10%] w-[80vw] h-[80vw] rounded-full animate-blob opacity-40 mix-blend-screen" style="background: radial-gradient(circle, rgba(10,132,255,0.6) 0%, rgba(10,132,255,0) 70%); will-change: transform;"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[90vw] h-[90vw] rounded-full animate-blob-reverse opacity-40 mix-blend-screen" style="animation-delay: 2s; background: radial-gradient(circle, rgba(236,72,153,0.5) 0%, rgba(236,72,153,0) 70%); will-change: transform;"></div>
        <div class="absolute top-[30%] left-[20%] w-[60vw] h-[60vw] rounded-full animate-blob opacity-30 mix-blend-screen" style="animation-delay: 4s; background: radial-gradient(circle, rgba(168,85,247,0.5) 0%, rgba(168,85,247,0) 70%); will-change: transform;"></div>
    </div>

    <!-- Interactive Canvas Area -->
    <main class="canvas-container-wrap" id="workspace">
        <div class="canvas-elevation" id="canvas-wrapper" style="transform: scale(0.244444);">
            <div class="canvas-container" style="width: 1080px; height: 1350px; position: relative; user-select: none;"><canvas id="posterCanvas" width="2328.75" height="2910.9375" class="lower-canvas" style="position: absolute; width: 1080px; height: 1350px; left: 0px; top: 0px; touch-action: none; user-select: none;"></canvas><canvas class="upper-canvas " width="2328.75" height="2910.9375" style="position: absolute; width: 1080px; height: 1350px; left: 0px; top: 0px; touch-action: none; user-select: none;"></canvas></div>
        </div>
    </main>

    <!-- Dynamic Island Toast -->
    <div id="toast" class="fixed top-12 left-1/2 glass-pill px-6 py-3 rounded-full flex items-center gap-3 hide">
        <i id="toast-icon" class="fa-solid fa-circle-check text-green-400 text-lg drop-shadow-[0_0_8px_rgba(74,222,128,0.5)]"></i>
        <span id="toast-msg" class="text-sm font-bold text-white tracking-wide">Packaging App...</span>
    </div>

    <!-- Top Action Bar -->
    <header class="absolute top-0 w-full z-20 px-3 sm:px-4 py-4 md:py-6 flex justify-between items-start pointer-events-none pt-[calc(env(safe-area-inset-top)+0.5rem)]">
        
        <!-- Left Pill: History & Zoom -->
        <div class="glass-pill rounded-full px-2 py-2 flex items-center gap-0.5 sm:gap-1 pointer-events-auto scale-[0.85] sm:scale-100 origin-top-left shadow-[0_10px_30px_rgba(0,0,0,0.3)]">
            <button id="btn-undo" onclick="undo()" class="btn-press w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:bg-white/10 hover:text-white opacity-40 cursor-not-allowed" title="Undo (Ctrl+Z)" style="opacity: 0.4; cursor: not-allowed;">
                <i class="fa-solid fa-rotate-left text-[15px]"></i>
            </button>
            <button id="btn-redo" onclick="redo()" class="btn-press w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:bg-white/10 hover:text-white opacity-40 cursor-not-allowed" title="Redo (Ctrl+Y)" style="opacity: 0.4; cursor: not-allowed;">
                <i class="fa-solid fa-rotate-right text-[15px]"></i>
            </button>
            <div class="w-[1px] h-5 bg-white/20 mx-1"></div>
            <button id="zoomBadge" onclick="cycleZoom()" class="btn-press px-3 sm:px-4 py-2 rounded-full text-[10px] sm:text-[11px] font-bold text-white tracking-widest hover:bg-white/10" title="Tap to cycle zoom">FIT</button>
        </div>
        
        <!-- Right Pill: Actions -->
        <div class="glass-pill rounded-full px-2 py-2 flex items-center gap-0.5 sm:gap-1 pointer-events-auto scale-[0.85] sm:scale-100 origin-top-right shadow-[0_10px_30px_rgba(0,0,0,0.3)]">
            <button onclick="openInfoModal()" class="btn-press w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:bg-white/10 hover:text-ios-blue" title="About &amp; Download">
                <i class="fa-solid fa-circle-info text-[15px]"></i>
            </button>
            <button onclick="toggleFullScreen()" class="btn-press w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:bg-white/10 hover:text-white" title="Fullscreen">
                <i id="fs-icon" class="fa-solid fa-expand text-[15px]"></i>
            </button>
            <button onclick="openClearModal()" class="btn-press w-10 h-10 rounded-full flex items-center justify-center text-white/70 hover:bg-red-500/20 hover:text-red-400" title="Clear Canvas">
                <i class="fa-solid fa-eraser text-[15px]"></i>
            </button>
            <div class="w-[1px] h-5 bg-white/20 mx-1"></div>
            <button onclick="toggleSheet('exportSheet')" class="btn-press px-4 sm:px-5 h-10 rounded-full bg-white text-black font-bold text-[10px] sm:text-[11px] uppercase tracking-wider shadow-[0_0_15px_rgba(255,255,255,0.3)] flex items-center gap-2 hover:bg-gray-200">
                <i class="fa-solid fa-arrow-up-from-bracket"></i> Save
            </button>
        </div>
    </header>

    <!-- Floating Dock -->
    <nav class="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-30 glass-pill px-6 sm:px-8 py-3 rounded-[2.5rem] flex items-center justify-around sm:justify-center gap-6 sm:gap-10 md:gap-14 mb-[env(safe-area-inset-bottom)] pointer-events-auto shadow-[0_20px_50px_rgba(0,0,0,0.5)] w-[90%] max-w-md sm:w-auto">
        <button onclick="toggleSheet('addSheet')" class="dock-icon" id="nav-add">
            <i class="fa-solid fa-circle-plus"></i><span>ADD</span>
        </button>
        <button onclick="toggleSheet('editSheet')" class="dock-icon" id="nav-edit">
            <i class="fa-solid fa-sliders"></i><span>EDIT</span>
        </button>
        <button onclick="toggleSheet('bgSheet')" class="dock-icon" id="nav-bg">
            <i class="fa-solid fa-layer-group"></i><span>CANVAS</span>
        </button>
    </nav>

    <!-- Clear Modal -->
    <div id="clearModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md">
        <div class="glass-sheet p-8 w-80 max-w-[90vw] text-center rounded-[2.5rem] border border-white/10 shadow-2xl">
            <div class="w-16 h-16 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center mx-auto mb-5 border border-red-500/30 shadow-[0_0_30px_rgba(239,68,68,0.4)]">
                <i class="fa-solid fa-eraser text-3xl"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2 tracking-tight">Clear Workspace?</h2>
            <p class="text-xs text-white/60 mb-8 leading-relaxed">This completely erases the canvas. You can undo this action if needed.</p>
            <div class="flex gap-3">
                <button onclick="closeClearModal()" class="btn-press flex-1 py-4 rounded-2xl bg-white/10 hover:bg-white/20 text-white text-sm font-semibold">Cancel</button>
                <button onclick="executeClearCanvas()" class="btn-press flex-1 py-4 rounded-2xl bg-red-500 hover:bg-red-600 text-white text-sm font-bold shadow-[0_4px_15px_rgba(239,68,68,0.4)]">Clear</button>
            </div>
        </div>
    </div>

    <!-- Info & Download Modal -->
    <div id="infoModal" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-md">
        <div class="glass-sheet p-8 w-[90vw] max-w-sm text-center rounded-[2.5rem] border border-white/10 shadow-2xl relative">
            <button onclick="closeInfoModal()" class="absolute top-5 right-5 w-8 h-8 rounded-full bg-white/10 text-white/70 flex items-center justify-center btn-press"><i class="fa-solid fa-xmark"></i></button>
            
            <div class="w-20 h-20 mx-auto mb-4 rounded-3xl bg-gradient-to-tr from-ios-blue to-purple-500 p-[2px] shadow-[0_10px_30px_rgba(10,132,255,0.4)]">
                <div class="w-full h-full bg-black/40 rounded-[1.4rem] flex items-center justify-center backdrop-blur-xl">
                    <i class="fa-solid fa-pen-nib text-3xl text-white"></i>
                </div>
            </div>
            
            <h2 class="text-2xl font-black text-white mb-1 tracking-tight">Studio Pro</h2>
            <p class="text-[10px] text-white/50 uppercase tracking-[0.2em] mb-6 font-bold">Version 2.5</p>
            
            <div class="glass-module p-5 mb-6 text-left border-white/5 bg-black/40 shadow-inner">
                <p class="text-[10px] text-white/40 mb-3 font-bold uppercase tracking-widest">Developer Details</p>
                <p class="text-sm text-white font-bold flex items-center"><i class="fa-solid fa-code text-ios-blue mr-3 w-4 text-center"></i> Designed by aravind .o.k</p>
                <p class="text-xs text-white/60 mt-2 flex items-center"><i class="fa-solid fa-envelope text-white/30 mr-3 w-4 text-center"></i> aravindok6@gmail.com</p>
                <p class="text-xs text-white/60 mt-2 flex items-center"><i class="fa-solid fa-keyboard text-white/30 mr-3 w-4 text-center"></i> Pro Tip: Use Ctrl+C / Ctrl+V</p>
            </div>

            <p class="text-[10px] text-white/40 mb-3 font-bold uppercase tracking-widest text-left pl-2">Get the Native App</p>
            <div class="flex flex-col gap-3">
                <button onclick="downloadAppHTML()" class="btn-press w-full py-4 rounded-2xl bg-white text-black text-sm font-bold flex items-center justify-center gap-3 shadow-[0_5px_15px_rgba(255,255,255,0.2)] hover:bg-gray-200">
                    <i class="fa-brands fa-apple text-xl"></i> Download App (iOS / Mac)
                </button>
                <button onclick="downloadAppHTML()" class="btn-press w-full py-4 rounded-2xl bg-[#1e293b] border border-white/10 text-white text-sm font-bold flex items-center justify-center gap-3 shadow-lg hover:bg-[#334155]">
                    <i class="fa-brands fa-google-play text-xl text-green-400"></i> Download App (Android / PC)
                </button>
            </div>
        </div>
    </div>

    <!-- ==================== SHEETS (ACCORDION UI) ==================== -->
    
    <!-- 1. ADD SHEET -->
    <div id="addSheet" class="sheet glass-sheet">
        <div class="sheet-drag-area"><div class="sheet-grabber"></div></div>
        <div class="px-5 pb-8 pt-0 scroll-panel h-full flex-1">
            
            <!-- Accordion: Magic Tools -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-[1.5rem]" onclick="toggleAccordion('acc-tools', this)">
                    <span class="font-bold text-sm flex items-center gap-3"><i class="fa-solid fa-wand-magic-sparkles text-ios-blue text-lg drop-shadow"></i> Tools &amp; Magic Text</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300 transform rotate-180"></i>
                </button>
                <div id="acc-tools" class="accordion-content px-1 pt-3 pb-2">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div onclick="toggleDrawMode()" id="drawModeBtn" class="tool-card gap-2 border-ios-blue/30 bg-ios-blue/10 py-5">
                            <i class="fa-solid fa-pen-nib text-3xl text-ios-blue drop-shadow-[0_0_8px_rgba(10,132,255,0.5)]"></i><span class="text-[11px] text-white font-bold tracking-wide mt-1">Brush Tool</span>
                        </div>
                        <div onclick="document.getElementById('imageLoader').click();" class="tool-card gap-2 py-5 border-white/10">
                            <i class="fa-regular fa-image text-3xl text-white/80"></i><span class="text-[11px] text-white font-bold tracking-wide mt-1">Add Photo</span>
                        </div>
                        <div onclick="addQRCode();" class="tool-card gap-2 py-4 col-span-2 flex-row border-white/10">
                            <i class="fa-solid fa-qrcode text-xl text-white"></i><span class="text-sm font-bold text-white ml-2">Generate QR Code</span>
                        </div>
                    </div>
                    
                    <div id="drawSettings" class="hidden glass-module p-5 mb-3">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-sm font-bold text-white">Brush Settings</span>
                            <button onclick="toggleDrawMode()" class="btn-press text-xs bg-red-500/20 text-red-400 px-4 py-2 rounded-full font-bold">Done</button>
                        </div>
                        <div class="flex items-center gap-4 mb-5">
                            <input type="color" id="brushColor" value="#0a84ff" onchange="updateBrush()">
                            <span class="text-xs font-semibold text-white/70">Color</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-semibold text-white/70 w-10">Size</span>
                            <input type="range" min="1" max="100" value="10" id="brushSize" class="flex-1" oninput="updateBrush()">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="add3DText('ENGLISH');" class="tool-card relative overflow-hidden group py-6 border-yellow-500/30">
                            <div class="absolute inset-0 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 opacity-50"></div>
                            <span class="f-oswald font-black text-yellow-500 text-2xl tracking-wider drop-shadow-md z-10">3D TITLE</span>
                        </div>
                        <div onclick="add3DText('MALAYALAM');" class="tool-card relative overflow-hidden group py-6 border-pink-500/30">
                            <div class="absolute inset-0 bg-gradient-to-br from-fuchsia-500/20 to-pink-500/20 opacity-50"></div>
                            <span class="f-malayalam font-black text-pink-400 text-2xl drop-shadow-md z-10"></span>
                        </div>
                        <div onclick="addTextPreset('heading');" class="tool-card py-5 border-white/10"><span class="text-sm font-bold text-white">Standard Heading</span></div>
                        <div onclick="addTextPreset('malayalam');" class="tool-card py-5 border-white/10"><span class="f-malayalam font-bold text-sm text-white"></span></div>
                        
                        <!-- NEW MAGIC TEXT -->
                        <div onclick="addTextPreset('neon');" class="tool-card py-5 border-cyan-500/30"><span class="text-sm font-bold text-white drop-shadow-[0_0_8px_rgba(6,182,212,0.8)]" style="font-family: 'Righteous'">Neon Cyber</span></div>
                        <div onclick="addTextPreset('outline');" class="tool-card py-5 border-white/10"><span class="text-sm font-black text-transparent" style="-webkit-text-stroke: 1px white; font-family: 'Anton'">OUTLINE X</span></div>
                        <div onclick="addTextPreset('vintage');" class="tool-card py-5 border-orange-500/30 col-span-2 flex-row"><span class="text-lg font-bold text-orange-200 italic" style="font-family: 'Playfair Display'">Vintage Serif Title</span></div>
                        <div onclick="addTextPreset('glitch');" class="tool-card py-5 border-red-500/30 col-span-2 flex-row"><span class="text-lg font-bold text-red-200" style="font-family: 'Space Grotesk'">GLITCH EFFECT</span></div>
                    </div>
                </div>
            </div>

            <!-- Accordion: Posters & Banners -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-posters', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-solid fa-scroll text-yellow-400"></i> Event Posters &amp; Banners</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-posters" class="accordion-content hidden px-1 pt-3 pb-2 grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <div onclick="addArtifact('cinematic');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20"><i class="fa-solid fa-film text-xl text-white/80"></i><span class="text-[9px] font-semibold text-white mt-1">Cinematic</span></div>
                    <div onclick="addArtifact('magazine');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20"><i class="fa-solid fa-book-open text-xl text-white/80"></i><span class="text-[9px] font-semibold text-white mt-1">Magazine</span></div>
                    <div onclick="addArtifact('retro80s');" class="glass-card tool-card-content rounded-xl gap-1 border-pink-500/30"><i class="fa-solid fa-compact-disc text-xl text-pink-400"></i><span class="text-[9px] font-semibold text-pink-200 mt-1">Retro 80s</span></div>
                    <div onclick="addArtifact('festivalBanner');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-ribbon text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Fest Banner</span></div>
                    <div onclick="addArtifact('eventHeader');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20"><i class="fa-solid fa-heading text-xl text-white/80"></i><span class="text-[9px] font-semibold text-white mt-1">Header</span></div>
                    <div onclick="addArtifact('elegantInvite');" class="glass-card tool-card-content rounded-xl gap-1 border-yellow-500/30"><i class="fa-solid fa-envelope-open-text text-xl text-yellow-400"></i><span class="text-[9px] font-semibold text-yellow-200 mt-1">Invite</span></div>
                    
                    <!-- NEW POSTERS -->
                    <div onclick="addArtifact('saleFlyer');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-tag text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Sale Flyer</span></div>
                    <div onclick="addArtifact('hiringNotice');" class="glass-card tool-card-content rounded-xl gap-1 border-blue-500/30"><i class="fa-solid fa-briefcase text-xl text-blue-400"></i><span class="text-[9px] font-semibold text-blue-200 mt-1">We're Hiring</span></div>
                    <div onclick="addArtifact('menuBoard');" class="glass-card tool-card-content rounded-xl gap-1 border-orange-500/30"><i class="fa-solid fa-utensils text-xl text-orange-400"></i><span class="text-[9px] font-semibold text-orange-200 mt-1">Menu Board</span></div>
                    <div onclick="addArtifact('partyFlyer');" class="glass-card tool-card-content rounded-xl gap-1 border-pink-500/30"><i class="fa-solid fa-champagne-glasses text-xl text-pink-400"></i><span class="text-[9px] font-semibold text-pink-200 mt-1">Party Flyer</span></div>
                    <div onclick="addArtifact('gymPromo');" class="glass-card tool-card-content rounded-xl gap-1 border-yellow-500/30 col-span-full flex-row py-4"><i class="fa-solid fa-dumbbell text-xl text-yellow-400"></i><span class="text-xs font-semibold text-yellow-200 ml-2">Gym / Fitness Promo</span></div>
                </div>
            </div>

            <!-- Accordion: Social & Content -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-social', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-brands fa-instagram text-pink-500"></i> Social &amp; Media Blocks</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-social" class="accordion-content hidden px-1 pt-3 pb-2 grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <div onclick="addArtifact('polaroid');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20"><i class="fa-regular fa-image text-xl text-white/80"></i><span class="text-[9px] font-semibold text-white mt-1">Polaroid</span></div>
                    <div onclick="addArtifact('podcast');" class="glass-card tool-card-content rounded-xl gap-1 border-purple-500/30"><i class="fa-solid fa-microphone-lines text-xl text-purple-400"></i><span class="text-[9px] font-semibold text-purple-200 mt-1">Podcast</span></div>
                    <div onclick="addArtifact('musicPlayer');" class="glass-card tool-card-content rounded-xl gap-1 border-green-500/30"><i class="fa-solid fa-music text-xl text-green-400"></i><span class="text-[9px] font-semibold text-green-200 mt-1">Music UI</span></div>
                    <div onclick="addArtifact('socialFollow');" class="glass-card tool-card-content rounded-xl gap-1 border-pink-500/30"><i class="fa-brands fa-instagram text-xl text-pink-400"></i><span class="text-[9px] font-semibold text-pink-200 mt-1">Follow Us</span></div>
                    <div onclick="addArtifact('youtubeThumb');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-brands fa-youtube text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Thumbnail</span></div>
                    <div onclick="addArtifact('liveStream');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-circle-dot text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Live Tag</span></div>
                    
                    <!-- NEW Social Mocks -->
                    <div onclick="addArtifact('igStory');" class="glass-card tool-card-content rounded-xl gap-1 border-pink-500/30"><i class="fa-solid fa-mobile-screen text-xl text-pink-400"></i><span class="text-[9px] font-semibold text-pink-200 mt-1">Story Frame</span></div>
                    <div onclick="addArtifact('chatBubble');" class="glass-card tool-card-content rounded-xl gap-1 border-blue-500/30"><i class="fa-solid fa-comment text-xl text-blue-400"></i><span class="text-[9px] font-semibold text-blue-200 mt-1">Chat Bubble</span></div>
                    <div onclick="addArtifact('videoPlayer');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-play text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Video UI</span></div>
                    
                    <div onclick="addArtifact('twitterPost');" class="glass-card tool-card-content rounded-xl gap-1 border-blue-500/30 col-span-full flex-row py-4"><i class="fa-brands fa-twitter text-2xl text-blue-400"></i><span class="text-xs font-semibold text-blue-200 ml-3">X / Twitter Mockup</span></div>
                    <div onclick="addArtifact('notification');" class="glass-card tool-card-content rounded-xl gap-1 border-white/30 col-span-full flex-row py-4"><i class="fa-solid fa-comment-dots text-2xl text-white"></i><span class="text-xs font-semibold text-white ml-3">Notification Pop-up</span></div>
                    <div onclick="addArtifact('webinar');" class="glass-card tool-card-content rounded-xl gap-1 border-teal-500/30 col-span-full flex-row py-4"><i class="fa-solid fa-laptop-code text-2xl text-teal-400"></i><span class="text-xs font-semibold text-teal-200 ml-3">Webinar Promo Block</span></div>
                </div>
            </div>

            <!-- Accordion: Emojis & Stickers (MASSIVELY EXPANDED) -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-emojis', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-regular fa-face-laugh-squint text-yellow-400"></i> Emojis &amp; Stickers</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-emojis" class="accordion-content hidden px-1 pt-3 pb-2 grid grid-cols-4 sm:grid-cols-6 gap-2">
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                    <div onclick="addEmoji('');" class="glass-card tool-card-content rounded-xl py-2 border-white/10 text-2xl"></div>
                </div>
            </div>

            <!-- Accordion: Premium FA Icons (EXPANDED) -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-icons', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-solid fa-icons text-orange-400"></i> Premium Vector Icons</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-icons" class="accordion-content hidden px-1 pt-3 pb-2 grid grid-cols-4 gap-2">
                    <div onclick="addIcon('\uf099', '#1da1f2', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-twitter text-2xl text-[#1da1f2]"></i></div>
                    <div onclick="addIcon('\uf16d', '#ec4899', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-instagram text-2xl text-pink-500"></i></div>
                    <div onclick="addIcon('\uf09a', '#0a66c2', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-facebook text-2xl text-[#0a66c2]"></i></div>
                    <div onclick="addIcon('\uf167', '#16a34a', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-youtube text-2xl text-red-600"></i></div>
                    
                    <div onclick="addIcon('\uf16a', '#ffffff', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-tiktok text-2xl text-white"></i></div>
                    <div onclick="addIcon('\uf1b4', '#1ed760', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-spotify text-2xl text-[#1ed760]"></i></div>
                    <div onclick="addIcon('\uf2c6', '#0088cc', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-telegram text-2xl text-[#0088cc]"></i></div>
                    <div onclick="addIcon('\uf0d5', '#bd081c', 'brand');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-brands fa-pinterest text-2xl text-[#bd081c]"></i></div>

                    <div onclick="addIcon('\uf0f3', '#facc15', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-bell text-2xl text-yellow-400"></i></div>
                    <div onclick="addIcon('\uf0e7', '#a855f7', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-bolt text-2xl text-purple-500"></i></div>
                    <div onclick="addIcon('\uf004', '#ef4444', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-heart text-2xl text-red-500"></i></div>
                    <div onclick="addIcon('\uf058', '#3b82f6', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-circle-check text-2xl text-blue-500"></i></div>
                    
                    <div onclick="addIcon('\uf015', '#ffffff', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-home text-2xl text-white"></i></div>
                    <div onclick="addIcon('\uf002', '#ffffff', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-search text-2xl text-white"></i></div>
                    <div onclick="addIcon('\uf030', '#ffffff', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-camera text-2xl text-white"></i></div>
                    <div onclick="addIcon('\uf007', '#ffffff', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-user text-2xl text-white"></i></div>
                    
                    <div onclick="addIcon('\uf0e0', '#ffffff', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-envelope text-2xl text-white"></i></div>
                    <div onclick="addIcon('\uf095', '#10b981', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-phone text-2xl text-emerald-400"></i></div>
                    <div onclick="addIcon('\uf04b', '#facc15', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-play text-2xl text-yellow-400"></i></div>
                    <div onclick="addIcon('\uf279', '#ef4444', 'solid');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-map-pin text-2xl text-red-500"></i></div>
                </div>
            </div>

            <!-- Accordion: Tags & Lower Thirds -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-tags', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-solid fa-tags text-teal-400"></i> Badges, Tags &amp; Alerts</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-tags" class="accordion-content hidden px-1 pt-3 pb-2 grid grid-cols-3 gap-2">
                    <div onclick="addArtifact('guestTag');" class="glass-card tool-card-content rounded-xl gap-1 border-teal-500/30"><i class="fa-solid fa-id-badge text-xl text-teal-400"></i><span class="text-[9px] font-semibold text-teal-200 mt-1">Guest Tag</span></div>
                    <div onclick="addArtifact('nameBadge');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-regular fa-address-card text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Hello Tag</span></div>
                    <div onclick="addArtifact('dateBadge');" class="glass-card tool-card-content rounded-xl gap-1 border-indigo-500/30"><i class="fa-regular fa-calendar-check text-xl text-indigo-400"></i><span class="text-[9px] font-semibold text-indigo-200 mt-1">Date Box</span></div>
                    <div onclick="addArtifact('saleBadge');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-tags text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Sale 50%</span></div>
                    <div onclick="addArtifact('certificate');" class="glass-card tool-card-content rounded-xl gap-1 border-yellow-500/30"><i class="fa-solid fa-award text-xl text-yellow-400"></i><span class="text-[9px] font-semibold text-yellow-200 mt-1">Award</span></div>
                    <div onclick="addArtifact('warning');" class="glass-card tool-card-content rounded-xl gap-1 border-yellow-500/30"><i class="fa-solid fa-triangle-exclamation text-xl text-yellow-400"></i><span class="text-[9px] font-semibold text-yellow-200 mt-1">Alert</span></div>
                    <div onclick="addArtifact('neonTitle');" class="glass-card tool-card-content rounded-xl gap-1 border-pink-500/30"><i class="fa-solid fa-bolt text-xl text-pink-400"></i><span class="text-[9px] font-semibold text-pink-200 mt-1">Neon Glow</span></div>
                    <div onclick="addArtifact('breakingNews');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-tv text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">News Bar</span></div>
                    <div onclick="addArtifact('glitchText');" class="glass-card tool-card-content rounded-xl gap-1 border-cyan-500/30"><i class="fa-solid fa-wave-square text-xl text-cyan-400"></i><span class="text-[9px] font-semibold text-cyan-200 mt-1">Glitch</span></div>
                    
                    <!-- NEW TAGS -->
                    <div onclick="addArtifact('newArrival');" class="glass-card tool-card-content rounded-xl gap-1 border-emerald-500/30"><i class="fa-solid fa-box-open text-xl text-emerald-400"></i><span class="text-[9px] font-semibold text-emerald-200 mt-1">New Arrival</span></div>
                    <div onclick="addArtifact('verifiedBadge');" class="glass-card tool-card-content rounded-xl gap-1 border-blue-500/30"><i class="fa-solid fa-certificate text-xl text-blue-400"></i><span class="text-[9px] font-semibold text-blue-200 mt-1">Verified</span></div>
                    <div onclick="addArtifact('soldOut');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-ban text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Sold Out</span></div>
                    
                    <div onclick="addArtifact('guaranteed');" class="glass-card tool-card-content rounded-xl gap-1 border-yellow-500/30 col-span-full flex-row py-4"><i class="fa-solid fa-shield-halved text-2xl text-yellow-400"></i><span class="text-xs font-semibold text-yellow-200 ml-2">100% Guaranteed Badge</span></div>
                </div>
            </div>

            <!-- Accordion: Information Blocks -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-info', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-solid fa-list-ul text-emerald-400"></i> Layout &amp; Info Blocks</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-info" class="accordion-content hidden px-1 pt-3 pb-2 grid grid-cols-2 sm:grid-cols-3 gap-2">
                    <div onclick="addArtifact('speakerProfile');" class="glass-card tool-card-content rounded-xl gap-1 border-blue-500/30"><i class="fa-solid fa-user-tie text-xl text-blue-400"></i><span class="text-[9px] font-semibold text-blue-200 mt-1">Speaker</span></div>
                    <div onclick="addArtifact('quoteBox');" class="glass-card tool-card-content rounded-xl gap-1 border-yellow-500/30"><i class="fa-solid fa-quote-left text-xl text-yellow-400"></i><span class="text-[9px] font-semibold text-yellow-200 mt-1">Quote</span></div>
                    <div onclick="addArtifact('malayalamQuote');" class="glass-card tool-card-content rounded-xl gap-1 border-pink-500/30"><span class="f-malayalam text-2xl font-bold text-pink-400 leading-none"></span><span class="text-[9px] font-semibold text-pink-200 mt-1">ML Quote</span></div>
                    <div onclick="addArtifact('testimonial');" class="glass-card tool-card-content rounded-xl gap-1 border-yellow-500/30"><i class="fa-solid fa-star-half-stroke text-xl text-yellow-400"></i><span class="text-[9px] font-semibold text-yellow-200 mt-1">Review</span></div>
                    <div onclick="addArtifact('contactBlock');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20"><i class="fa-solid fa-address-book text-xl text-white/80"></i><span class="text-[9px] font-semibold text-white mt-1">Contact</span></div>
                    <div onclick="addArtifact('stepBlock');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20"><i class="fa-solid fa-list-ol text-xl text-white/80"></i><span class="text-[9px] font-semibold text-white mt-1">Steps 1-2-3</span></div>
                    <div onclick="addArtifact('locationTag');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-location-dot text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Location</span></div>
                    <div onclick="addArtifact('pricingTier');" class="glass-card tool-card-content rounded-xl gap-1 border-green-500/30"><i class="fa-solid fa-money-check-dollar text-xl text-green-400"></i><span class="text-[9px] font-semibold text-green-200 mt-1">Pricing</span></div>
                    <div onclick="addArtifact('glassCard');" class="glass-card tool-card-content rounded-xl gap-1 border-indigo-500/30"><i class="fa-solid fa-address-card text-xl text-indigo-400"></i><span class="text-[9px] font-semibold text-indigo-200 mt-1">Glass ID</span></div>
                    <div onclick="addArtifact('vsScore');" class="glass-card tool-card-content rounded-xl gap-1 border-orange-500/30"><i class="fa-solid fa-trophy text-xl text-orange-400"></i><span class="text-[9px] font-semibold text-orange-200 mt-1">VS Score</span></div>
                    <div onclick="addArtifact('movieRating');" class="glass-card tool-card-content rounded-xl gap-1 border-red-500/30"><i class="fa-solid fa-ticket text-xl text-red-400"></i><span class="text-[9px] font-semibold text-red-200 mt-1">Rating</span></div>
                    <div onclick="addArtifact('countdown');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20"><i class="fa-solid fa-stopwatch text-xl text-white/80"></i><span class="text-[9px] font-semibold text-white mt-1">Countdown</span></div>
                    
                    <!-- NEW BLOCKS -->
                    <div onclick="addArtifact('authorBio');" class="glass-card tool-card-content rounded-xl gap-1 border-white/30"><i class="fa-solid fa-user-pen text-xl text-white"></i><span class="text-[9px] font-semibold text-white mt-1">Author Bio</span></div>
                    <div onclick="addArtifact('calendar');" class="glass-card tool-card-content rounded-xl gap-1 border-white/20 col-span-full sm:col-span-2 flex-row"><i class="fa-regular fa-calendar-days text-xl text-white/80"></i><span class="text-[10px] font-semibold text-white ml-2">Calendar Block</span></div>
                    
                    <div onclick="addArtifact('statsBlock');" class="glass-card tool-card-content rounded-xl gap-1 border-blue-500/30 col-span-full flex-row py-4"><i class="fa-solid fa-chart-simple text-2xl text-blue-400"></i><span class="text-xs font-semibold text-white ml-3">Stats &amp; Metrics Block</span></div>
                    <div onclick="addArtifact('featureList');" class="glass-card tool-card-content rounded-xl gap-1 border-emerald-500/30 col-span-full flex-row py-4"><i class="fa-solid fa-list-check text-2xl text-emerald-400"></i><span class="text-xs font-semibold text-emerald-200 ml-3">Feature Checklist</span></div>
                </div>
            </div>

            <!-- Accordion: Shapes & Vectors -->
            <div class="mb-6">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-[1.5rem]" onclick="toggleAccordion('acc-shapes', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-solid fa-shapes text-purple-400 text-lg"></i> Shapes &amp; Vectors</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-shapes" class="accordion-content hidden px-1 pt-3 pb-2 grid grid-cols-3 sm:grid-cols-4 gap-2">
                    <div onclick="addShape('rect');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-square text-2xl text-white/80"></i></div>
                    <div onclick="addShape('circle');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-circle text-2xl text-white/80"></i></div>
                    <div onclick="addShape('triangle');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-caret-up text-3xl text-white/80"></i></div>
                    <div onclick="addShape('hexagon');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-stop text-2xl text-white/80"></i></div>
                    <div onclick="addShape('star');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-star text-2xl text-white/80"></i></div>
                    <div onclick="addShape('badge');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-certificate text-2xl text-white/80"></i></div>
                    <div onclick="addShape('arrow');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-arrow-right-long text-2xl text-white/80"></i></div>
                    <div onclick="addShape('ribbon');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-bookmark text-2xl text-white/80"></i></div>
                    <div onclick="addShape('line');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-minus text-2xl text-white/80 transform rotate-45"></i></div>
                    <div onclick="addShape('frame');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-regular fa-square text-2xl text-white/80"></i></div>
                    
                    <!-- NEW SHAPES -->
                    <div onclick="addShape('diamond');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-diamond text-2xl text-white/80"></i></div>
                    <div onclick="addShape('cross');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-plus text-2xl text-white/80"></i></div>
                    <div onclick="addShape('pentagon');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-house text-2xl text-white/80"></i></div>
                    <div onclick="addShape('octagon');" class="glass-card tool-card-content rounded-xl py-4 border-white/10"><i class="fa-solid fa-stop text-2xl text-white/80 transform rotate-45"></i></div>
                </div>
            </div>

            <input type="file" id="imageLoader" accept="image/*" class="hidden">
        </div>
    </div>

    <!-- 2. EDIT SHEET -->
    <div id="editSheet" class="sheet glass-sheet">
        <div class="sheet-drag-area"><div class="sheet-grabber"></div></div>
        <div class="px-5 pb-8 pt-0 scroll-panel h-full flex-1">
            <div id="editEmpty" class="flex flex-col items-center justify-center py-16 opacity-50">
                <i class="fa-solid fa-hand-pointer text-4xl mb-4 text-ios-blue drop-shadow-[0_0_15px_rgba(10,132,255,0.8)]"></i>
                <p class="text-sm font-bold tracking-wide">Select an object on the canvas to edit</p>
            </div>
            
            <div id="editContent" class="hidden flex-col">
                <!-- Quick Actions Bar -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-4 border-b border-white/10">
                    <button onclick="duplicateSelected()" class="btn-press bg-white/10 p-3 rounded-xl min-w-[3rem] flex items-center justify-center" title="Duplicate"><i class="fa-solid fa-copy"></i></button>
                    <button onclick="deleteSelected()" class="btn-press bg-red-500/20 text-red-400 p-3 rounded-xl min-w-[3rem] flex items-center justify-center" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    <button id="lockBtn" onclick="toggleLock()" class="btn-press bg-white/10 p-3 rounded-xl min-w-[3rem] flex items-center justify-center" title="Lock/Unlock"><i class="fa-solid fa-lock-open"></i></button>
                    <div class="w-[1px] bg-white/10 mx-1"></div>
                    <button onclick="bringForward()" class="btn-press bg-white/10 p-3 rounded-xl min-w-[3rem] flex items-center justify-center" title="Bring Forward"><i class="fa-solid fa-layer-group"></i><i class="fa-solid fa-arrow-up text-[10px] ml-1"></i></button>
                    <button onclick="sendBackward()" class="btn-press bg-white/10 p-3 rounded-xl min-w-[3rem] flex items-center justify-center" title="Send Backward"><i class="fa-solid fa-layer-group"></i><i class="fa-solid fa-arrow-down text-[10px] ml-1"></i></button>
                    <div class="w-[1px] bg-white/10 mx-1"></div>
                    <button id="btn-group" onclick="groupSelected()" class="btn-press bg-ios-blue/20 text-ios-blue p-3 rounded-xl min-w-[3rem] flex items-center justify-center" style="display:none;" title="Group"><i class="fa-solid fa-object-group"></i></button>
                    <button id="btn-ungroup" onclick="ungroupSelected()" class="btn-press bg-ios-blue/20 text-ios-blue p-3 rounded-xl min-w-[3rem] flex items-center justify-center" style="display:none;" title="Ungroup"><i class="fa-solid fa-object-ungroup"></i></button>
                </div>

                <!-- Alignment Bar -->
                <div class="flex gap-2 mb-4 justify-between bg-black/30 p-2 rounded-2xl border border-white/5">
                    <button onclick="alignObject('left')" class="btn-press p-2 text-white/60 hover:text-white"><i class="fa-solid fa-align-left"></i></button>
                    <button onclick="alignObject('centerH')" class="btn-press p-2 text-white/60 hover:text-white"><i class="fa-solid fa-align-center"></i></button>
                    <button onclick="alignObject('right')" class="btn-press p-2 text-white/60 hover:text-white"><i class="fa-solid fa-align-right"></i></button>
                    <div class="w-[1px] bg-white/10 my-2"></div>
                    <button onclick="alignObject('top')" class="btn-press p-2 text-white/60 hover:text-white transform -rotate-90"><i class="fa-solid fa-align-right"></i></button>
                    <button onclick="alignObject('centerV')" class="btn-press p-2 text-white/60 hover:text-white transform -rotate-90"><i class="fa-solid fa-align-center"></i></button>
                    <button onclick="alignObject('bottom')" class="btn-press p-2 text-white/60 hover:text-white transform -rotate-90"><i class="fa-solid fa-align-left"></i></button>
                </div>

                <!-- Contextual Tabs -->
                <div id="editTabs" class="flex gap-2 overflow-x-auto mb-4 pb-1 no-scrollbar"></div>

                <!-- TEXT Section -->
                <div id="sec-text" class="prop-section">
                    <textarea id="val-text" oninput="updateProp('text', this.value)" class="w-full glass-input p-4 mb-4 text-sm" rows="3" placeholder="Enter text here..."></textarea>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1 block">Font Family</label>
                            <select id="val-font" onchange="updateProp('fontFamily', this.value)" class="w-full glass-input p-3 text-sm"><option value="Inter">Inter</option><option value="Anek Malayalam">Anek Malayalam</option><option value="Abril Fatface">Abril Fatface</option><option value="Anton">Anton</option><option value="Bungee">Bungee</option><option value="Baloo Chettan 2">Baloo Chettan 2</option><option value="Bebas Neue">Bebas Neue</option><option value="Caveat">Caveat</option><option value="Chilanka">Chilanka</option><option value="Cinzel">Cinzel</option><option value="Dancing Script">Dancing Script</option><option value="Gayathri">Gayathri</option><option value="Impact">Impact</option><option value="Lato">Lato</option><option value="Lobster">Lobster</option><option value="Manjari">Manjari</option><option value="Meera Inimai">Meera Inimai</option><option value="Merriweather">Merriweather</option><option value="Mina">Mina</option><option value="Montserrat">Montserrat</option><option value="Mukta Malar">Mukta Malar</option><option value="Noto Sans Malayalam">Noto Sans Malayalam</option><option value="Noto Serif Malayalam">Noto Serif Malayalam</option><option value="Open Sans">Open Sans</option><option value="Oswald">Oswald</option><option value="Pacifico">Pacifico</option><option value="Permanent Marker">Permanent Marker</option><option value="Playfair Display">Playfair Display</option><option value="Poppins">Poppins</option><option value="Raleway">Raleway</option><option value="Righteous">Righteous</option><option value="Roboto">Roboto</option><option value="Space Grotesk">Space Grotesk</option><option value="Syne">Syne</option></select>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1 block">Font Size</label>
                            <input type="range" id="val-fontsize" min="10" max="400" oninput="updateProp('fontSize', parseInt(this.value))">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1 block">Font Weight</label>
                            <select id="val-weight" onchange="updateProp('fontWeight', this.value)" class="w-full glass-input p-3 text-sm">
                                <option value="normal">Normal</option><option value="bold">Bold</option><option value="900">Black</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1 block">Alignment</label>
                            <div class="segment-control">
                                <div id="align-left" class="segment-btn active" onclick="updateTextAlign('left')"><i class="fa-solid fa-align-left"></i></div>
                                <div id="align-center" class="segment-btn" onclick="updateTextAlign('center')"><i class="fa-solid fa-align-center"></i></div>
                                <div id="align-right" class="segment-btn" onclick="updateTextAlign('right')"><i class="fa-solid fa-align-right"></i></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1 block">Line Height</label>
                            <input type="range" id="val-lineheight" min="0.5" max="3" step="0.1" oninput="updateProp('lineHeight', parseFloat(this.value))">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1 block">Letter Spacing</label>
                            <input type="range" id="val-letterspace" min="-100" max="500" step="10" oninput="updateProp('charSpacing', parseInt(this.value))">
                        </div>
                    </div>
                </div>

                <!-- STYLE Section -->
                <div id="sec-style" class="prop-section">
                    <div class="mb-5">
                        <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Opacity</label>
                        <input type="range" id="val-opacity" min="0" max="1" step="0.05" oninput="updateProp('opacity', parseFloat(this.value))">
                    </div>
                    
                    <div id="wrap-fill" class="mb-5">
                        <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Fill Color</label>
                        <div class="flex items-center gap-4">
                            <input type="color" id="val-fill" onchange="updateProp('fill', this.value)">
                            <input type="text" id="val-fill-hex" onchange="updateProp('fill', this.value)" class="glass-input p-3 flex-1 text-sm font-mono uppercase" placeholder="#FFFFFF">
                        </div>
                    </div>
                    
                    <div id="wrap-3d-colors" class="grid grid-cols-2 gap-4 mb-5" style="display:none;">
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Face Color</label>
                            <div class="flex items-center gap-3">
                                <input type="color" id="val-3d-face" onchange="updateProp('faceColor', this.value)">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Extrude Color</label>
                            <div class="flex items-center gap-3">
                                <input type="color" id="val-3d-ext" onchange="updateProp('extColor', this.value)">
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Extrude Depth</label>
                            <input type="range" id="val-3d-depth" min="1" max="50" oninput="updateProp('depth', parseInt(this.value))">
                        </div>
                    </div>
                    
                    <div id="wrap-stroke" class="mb-5 bg-black/20 p-4 rounded-2xl border border-white/5">
                        <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-3 block">Outline / Stroke</label>
                        <div class="flex items-center gap-4 mb-3">
                            <input type="color" id="val-stroke-color" onchange="updateProp('stroke', this.value)">
                            <span class="text-xs font-semibold text-white/70">Stroke Color</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-semibold text-white/70 w-12">Width</span>
                            <input type="range" id="val-stroke-width" min="0" max="30" step="1" oninput="updateProp('strokeWidth', parseInt(this.value))" class="flex-1">
                        </div>
                    </div>
                    
                    <div id="wrap-radius" class="mb-5">
                        <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Corner Radius</label>
                        <input type="range" id="val-radius" min="0" max="200" step="1" oninput="updateRadius(this.value)">
                    </div>
                </div>

                <!-- EFFECTS Section -->
                <div id="sec-effects" class="prop-section">
                    <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-4 block">Drop Shadow</label>
                    <div class="flex items-center gap-4 mb-5">
                        <input type="color" id="val-shadow-color" onchange="updateShadow()">
                        <span class="text-xs font-semibold text-white/70">Shadow Color</span>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-5">
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1 block">Blur Amount</label>
                            <input type="range" id="val-shadow-blur" min="0" max="100" oninput="updateShadow()">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1 block">X Offset</label>
                            <input type="range" id="val-shadow-offsetx" min="-100" max="100" oninput="updateShadow()">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1 block">Y Offset</label>
                            <input type="range" id="val-shadow-offsety" min="-100" max="100" oninput="updateShadow()">
                        </div>
                    </div>
                </div>
                
                <!-- IMAGE Section -->
                <div id="sec-image" class="prop-section">
                    <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-4 block">Adjustments</label>
                    <div class="grid grid-cols-1 gap-5 mb-6">
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1 block flex justify-between">Brightness <i class="fa-solid fa-sun"></i></label>
                            <input type="range" id="val-img-brightness" min="-1" max="1" step="0.05" value="0" oninput="updateImageSliders()">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1 block flex justify-between">Contrast <i class="fa-solid fa-circle-half-stroke"></i></label>
                            <input type="range" id="val-img-contrast" min="-1" max="1" step="0.05" value="0" oninput="updateImageSliders()">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1 block flex justify-between">Saturation <i class="fa-solid fa-droplet"></i></label>
                            <input type="range" id="val-img-saturation" min="-1" max="1" step="0.05" value="0" oninput="updateImageSliders()">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase tracking-wider text-white/40 font-bold mb-1 block flex justify-between">Blur <i class="fa-solid fa-smog"></i></label>
                            <input type="range" id="val-img-blur" min="0" max="1" step="0.05" value="0" oninput="updateImageSliders()">
                        </div>
                    </div>
                    
                    <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Quick Filters</label>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                        <button onclick="applyImageEffect('none')" class="btn-press bg-white/10 px-4 py-2 text-xs font-bold rounded-xl min-w-max">Normal</button>
                        <button onclick="applyImageEffect('grayscale')" class="btn-press bg-white/10 px-4 py-2 text-xs font-bold rounded-xl min-w-max">B &amp; W</button>
                        <button onclick="applyImageEffect('sepia')" class="btn-press bg-white/10 px-4 py-2 text-xs font-bold rounded-xl min-w-max">Sepia</button>
                        <button onclick="applyImageEffect('invert')" class="btn-press bg-white/10 px-4 py-2 text-xs font-bold rounded-xl min-w-max">Invert</button>
                    </div>
                    
                    <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Crop Masks</label>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                        <button onclick="setImageCrop('square')" class="btn-press bg-white/10 px-4 py-3 text-lg rounded-xl"><i class="fa-solid fa-square"></i></button>
                        <button onclick="setImageCrop('rounded')" class="btn-press bg-white/10 px-4 py-3 text-lg rounded-xl"><i class="fa-solid fa-square-minus"></i></button>
                        <button onclick="setImageCrop('circle')" class="btn-press bg-white/10 px-4 py-3 text-lg rounded-xl"><i class="fa-solid fa-circle"></i></button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- 3. CANVAS / BG SHEET -->
    <div id="bgSheet" class="sheet glass-sheet">
        <div class="sheet-drag-area"><div class="sheet-grabber"></div></div>
        <div class="px-5 pb-8 pt-0 scroll-panel h-full flex-1">
            <h3 class="text-sm font-bold mb-4 text-white flex items-center gap-2"><i class="fa-solid fa-crop-simple text-ios-blue"></i> Canvas Dimensions</h3>
            <div class="grid grid-cols-3 sm:grid-cols-4 gap-2 mb-6">
                <button onclick="setCanvasRatio('square')" class="btn-press bg-white/10 p-2 rounded-xl text-xs font-bold text-center">Square<br><span class="text-[9px] font-normal text-white/60">1:1</span></button>
                <button onclick="setCanvasRatio('photo')" class="btn-press bg-white/10 p-2 rounded-xl text-xs font-bold text-center">Photo<br><span class="text-[9px] font-normal text-white/60">4:3</span></button>
                <button onclick="setCanvasRatio('story')" class="btn-press bg-ios-blue/20 border border-ios-blue/30 text-ios-blue p-2 rounded-xl text-xs font-bold text-center">Story<br><span class="text-[9px] font-normal opacity-80">9:16</span></button>
                <button onclick="setCanvasRatio('landscape')" class="btn-press bg-white/10 p-2 rounded-xl text-xs font-bold text-center">Video<br><span class="text-[9px] font-normal text-white/60">16:9</span></button>
                <button onclick="setCanvasRatio('a4')" class="btn-press bg-white/10 p-2 rounded-xl text-xs font-bold text-center">A4 Doc<br><span class="text-[9px] font-normal text-white/60">Print</span></button>
                <button onclick="setCanvasRatio('youtube')" class="btn-press bg-white/10 p-2 rounded-xl text-xs font-bold text-center">YT Thumb<br><span class="text-[9px] font-normal text-white/60">1280x720</span></button>
                <button onclick="setCanvasRatio('twitter')" class="btn-press bg-white/10 p-2 rounded-xl text-xs font-bold text-center">Twitter<br><span class="text-[9px] font-normal text-white/60">Post</span></button>
                <button onclick="setCanvasRatio('fbCover')" class="btn-press bg-white/10 p-2 rounded-xl text-xs font-bold text-center">FB Cover<br><span class="text-[9px] font-normal text-white/60">Banner</span></button>
            </div>

            <!-- Accordion: Elegant Libraries (NEW) -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-[1.5rem]" onclick="toggleAccordion('acc-bg-premium', this)">
                    <span class="font-bold text-sm flex items-center gap-3"><i class="fa-solid fa-gem text-purple-400 text-lg drop-shadow"></i> Elegant Libraries</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300 transform rotate-180"></i>
                </button>
                <div id="acc-bg-premium" class="accordion-content px-1 pt-3 pb-2">
                    
                    <p class="text-[10px] text-white/40 font-bold mb-2 uppercase tracking-widest pl-1">Generated Aura Meshes</p>
                    <div class="grid grid-cols-2 gap-2 mb-5">
                        <button onclick="generateMeshBg('#0f172a', '#3b82f6', '#a855f7', '#ec4899')" class="btn-press h-20 rounded-2xl relative overflow-hidden group flex items-center justify-center border border-white/10 shadow-lg">
                            <div class="absolute inset-0 bg-slate-900"></div>
                            <div class="absolute top-[-20%] right-[-20%] w-24 h-24 bg-blue-500 rounded-full blur-[20px] opacity-70"></div>
                            <div class="absolute bottom-[-20%] left-[-20%] w-24 h-24 bg-purple-500 rounded-full blur-[20px] opacity-70"></div>
                            <div class="absolute bottom-[20%] right-[20%] w-16 h-16 bg-pink-500 rounded-full blur-[20px] opacity-70"></div>
                            <span class="relative z-10 text-[11px] font-bold text-white drop-shadow-md bg-black/40 px-3 py-1 rounded-full backdrop-blur-md border border-white/10">Dark Galaxy</span>
                        </button>
                        <button onclick="generateMeshBg('#f8fafc', '#93c5fd', '#fbcfe8', '#fde047')" class="btn-press h-20 rounded-2xl relative overflow-hidden group flex items-center justify-center border border-white/10 shadow-lg">
                            <div class="absolute inset-0 bg-slate-50"></div>
                            <div class="absolute top-[-20%] left-[-20%] w-24 h-24 bg-blue-300 rounded-full blur-[20px] opacity-80"></div>
                            <div class="absolute bottom-[-20%] right-[-20%] w-24 h-24 bg-pink-200 rounded-full blur-[20px] opacity-80"></div>
                            <div class="absolute bottom-[20%] left-[20%] w-16 h-16 bg-yellow-300 rounded-full blur-[20px] opacity-80"></div>
                            <span class="relative z-10 text-[11px] font-bold text-slate-800 drop-shadow-md bg-white/60 px-3 py-1 rounded-full backdrop-blur-md border border-black/5">Light Aura</span>
                        </button>
                        <button onclick="generateMeshBg('#083344', '#10b981', '#0ea5e9', '#0284c7')" class="btn-press h-20 rounded-2xl relative overflow-hidden group flex items-center justify-center border border-white/10 shadow-lg">
                            <div class="absolute inset-0 bg-cyan-950"></div>
                            <div class="absolute top-[10%] right-[-10%] w-24 h-24 bg-emerald-500 rounded-full blur-[20px] opacity-60"></div>
                            <div class="absolute bottom-[-10%] left-[-10%] w-32 h-32 bg-sky-500 rounded-full blur-[20px] opacity-60"></div>
                            <span class="relative z-10 text-[11px] font-bold text-white drop-shadow-md bg-black/40 px-3 py-1 rounded-full backdrop-blur-md border border-white/10">Deep Sea</span>
                        </button>
                        <button onclick="generateMeshBg('#4c0519', '#f43f5e', '#f59e0b', '#ec4899')" class="btn-press h-20 rounded-2xl relative overflow-hidden group flex items-center justify-center border border-white/10 shadow-lg">
                            <div class="absolute inset-0 bg-rose-950"></div>
                            <div class="absolute top-0 right-0 w-24 h-24 bg-rose-500 rounded-full blur-[20px] opacity-70"></div>
                            <div class="absolute bottom-0 left-0 w-24 h-24 bg-amber-500 rounded-full blur-[20px] opacity-70"></div>
                            <span class="relative z-10 text-[11px] font-bold text-white drop-shadow-md bg-black/40 px-3 py-1 rounded-full backdrop-blur-md border border-white/10">Sunset Dream</span>
                        </button>
                    </div>

                    <p class="text-[10px] text-white/40 font-bold mb-2 uppercase tracking-widest pl-1">Premium Gradients</p>
                    <div class="grid grid-cols-3 gap-2">
                        <div onclick="applyPresetBg('sunset')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #ff7e5f, #feb47b)"></div>
                        <div onclick="applyPresetBg('ocean')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #2b5876, #4e4376)"></div>
                        <div onclick="applyPresetBg('aurora')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #00c6ff, #0072ff)"></div>
                        <div onclick="applyPresetBg('cyber')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #f80759, #bc4e9c)"></div>
                        <div onclick="applyPresetBg('midnight')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #232526, #414345)"></div>
                        <div onclick="applyPresetBg('peach')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: radial-gradient(circle, #ed4264, #ffedbc)"></div>
                        <div onclick="applyPresetBg('lush')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #56ab2f, #a8e063)"></div>
                        <div onclick="applyPresetBg('rose')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #ff9a9e, #fecfef)"></div>
                        <div onclick="applyPresetBg('gold')" class="h-14 rounded-2xl btn-press shadow-lg border border-white/10" style="background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c)"></div>
                    </div>
                </div>
            </div>

            <!-- Accordion: Basic & Custom Backgrounds -->
            <div class="mb-3">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-bg-basic', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-solid fa-fill-drip text-pink-500"></i> Basic Colors &amp; Generator</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-bg-basic" class="accordion-content hidden px-1 pt-3 pb-2">
                    <div class="mb-5">
                        <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Solid Colors</label>
                        <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                            <div class="w-10 h-10 rounded-full bg-black border border-white/20 flex-shrink-0 btn-press shadow-lg" onclick="setBgColor('#000000')"></div>
                            <div class="w-10 h-10 rounded-full bg-white border border-white/20 flex-shrink-0 btn-press shadow-lg" onclick="setBgColor('#ffffff')"></div>
                            <div class="w-10 h-10 rounded-full bg-[#ef4444] border border-white/20 flex-shrink-0 btn-press shadow-lg" onclick="setBgColor('#ef4444')"></div>
                            <div class="w-10 h-10 rounded-full bg-[#3b82f6] border border-white/20 flex-shrink-0 btn-press shadow-lg" onclick="setBgColor('#3b82f6')"></div>
                            <div class="w-10 h-10 rounded-full bg-[#22c55e] border border-white/20 flex-shrink-0 btn-press shadow-lg" onclick="setBgColor('#22c55e')"></div>
                            <div class="w-10 h-10 rounded-full bg-[#facc15] border border-white/20 flex-shrink-0 btn-press shadow-lg" onclick="setBgColor('#facc15')"></div>
                            <div class="w-10 h-10 rounded-full bg-[#ec4899] border border-white/20 flex-shrink-0 btn-press shadow-lg" onclick="setBgColor('#ec4899')"></div>
                            <div class="w-10 h-10 rounded-full bg-transparent flex items-center justify-center border border-white/20 flex-shrink-0 btn-press" onclick="setBgColor('transparent')"><i class="fa-solid fa-ban text-white/50"></i></div>
                        </div>
                    </div>
                    
                    <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                        <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-3 block">Custom Generator</label>
                        <div class="segment-control mb-4">
                            <div id="btn-linear" class="segment-btn active" onclick="setGenType('linear')">Linear</div>
                            <div id="btn-radial" class="segment-btn" onclick="setGenType('radial')">Radial</div>
                        </div>
                        <div class="flex items-center gap-3 mb-4">
                            <input type="color" id="gen-col1" value="#ff007a" onchange="applyCustomGradient()">
                            <i class="fa-solid fa-arrow-right text-white/30 text-xs"></i>
                            <input type="color" id="gen-col2" value="#4a00e0" onchange="applyCustomGradient()">
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-semibold text-white/70">Angle</span>
                            <input type="range" id="gen-angle" min="0" max="360" value="135" class="flex-1" oninput="applyCustomGradient()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accordion: Patterns & Image -->
            <div class="mb-6">
                <button class="accordion-btn flex justify-between items-center w-full p-4 glass-card rounded-2xl" onclick="toggleAccordion('acc-bg-pattern', this)">
                    <span class="font-bold text-xs flex items-center gap-2"><i class="fa-solid fa-chess-board text-emerald-400"></i> Textures &amp; Images</span>
                    <i class="fa-solid fa-chevron-down text-white/50 transition-transform duration-300"></i>
                </button>
                <div id="acc-bg-pattern" class="accordion-content hidden px-1 pt-3 pb-2">
                    <div class="mb-4">
                        <label class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-2 block">Patterns</label>
                        <div class="grid grid-cols-5 gap-2">
                            <button onclick="setBgPattern('grid')" class="btn-press bg-white/10 p-3 rounded-xl flex justify-center"><i class="fa-solid fa-table-cells"></i></button>
                            <button onclick="setBgPattern('dots')" class="btn-press bg-white/10 p-3 rounded-xl flex justify-center"><i class="fa-solid fa-braille"></i></button>
                            <button onclick="setBgPattern('lines')" class="btn-press bg-white/10 p-3 rounded-xl flex justify-center"><i class="fa-solid fa-bars"></i></button>
                            <button onclick="setBgPattern('crosshatch')" class="btn-press bg-white/10 p-3 rounded-xl flex justify-center"><i class="fa-solid fa-border-all"></i></button>
                            <button onclick="setBgPattern('plus')" class="btn-press bg-white/10 p-3 rounded-xl flex justify-center"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div>
                        <button onclick="document.getElementById('bgImageUploader').click()" class="btn-press w-full py-4 bg-white text-black font-bold rounded-2xl flex items-center justify-center gap-2 shadow-[0_5px_15px_rgba(255,255,255,0.2)]">
                            <i class="fa-solid fa-image"></i> Set Background Image
                        </button>
                        <input type="file" id="bgImageUploader" accept="image/*" class="hidden">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 4. EXPORT SHEET -->
    <div id="exportSheet" class="sheet glass-sheet">
        <div class="sheet-drag-area"><div class="sheet-grabber"></div></div>
        <div class="px-5 pb-8 pt-0 scroll-panel flex-1 flex flex-col items-center">
            
            <div class="w-24 h-24 rounded-full bg-gradient-to-tr from-green-400 to-emerald-600 flex items-center justify-center mb-4 shadow-[0_10px_30px_rgba(16,185,129,0.4)]">
                <i class="fa-solid fa-cloud-arrow-down text-4xl text-white"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-white mb-2">Save &amp; Export</h2>
            <p class="text-xs text-white/50 text-center mb-8 px-4">Download your masterpiece directly to your device or save the project file to edit later.</p>
            
            <div class="w-full grid grid-cols-2 gap-3 mb-3">
                <button onclick="executeExport('png', 1)" class="btn-press py-4 bg-white/10 border border-white/20 rounded-2xl font-bold text-sm flex flex-col items-center gap-2">
                    <span class="text-xs text-white/50 font-normal">Standard</span>PNG
                </button>
                <button onclick="executeExport('png', 3)" class="btn-press py-4 bg-ios-blue text-white rounded-2xl font-bold text-sm shadow-[0_5px_15px_rgba(10,132,255,0.4)] flex flex-col items-center gap-2">
                    <span class="text-xs text-white/70 font-normal">High Quality</span>PNG (HD)
                </button>
                <button onclick="executeExport('jpeg', 1)" class="btn-press py-4 bg-white/10 border border-white/20 rounded-2xl font-bold text-sm flex flex-col items-center gap-2">
                    <span class="text-xs text-white/50 font-normal">Smaller Size</span>JPG
                </button>
                <button onclick="executeExport('jpeg', 3)" class="btn-press py-4 bg-white/10 border border-white/20 rounded-2xl font-bold text-sm flex flex-col items-center gap-2">
                    <span class="text-xs text-white/50 font-normal">Best for Web</span>JPG (HD)
                </button>
            </div>
            
            <div class="w-full mt-4 border-t border-white/10 pt-6 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button onclick="exportProject()" class="btn-press py-3 bg-purple-500/20 text-purple-300 border border-purple-500/30 rounded-xl text-xs font-bold flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-export"></i> Save Project
                </button>
                <button onclick="document.getElementById('importProjectLoader').click()" class="btn-press py-3 bg-pink-500/20 text-pink-300 border border-pink-500/30 rounded-xl text-xs font-bold flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-import"></i> Load Project
                </button>
                <input type="file" id="importProjectLoader" accept=".json" onchange="importProject(event)" class="hidden">
            </div>
        </div>
    </div>

    <script>
        // --- Fabric Initialization ---
        const canvas = new fabric.Canvas('posterCanvas', {
            preserveObjectStacking: true, backgroundColor: '#ffffff', 
            selectionColor: 'rgba(10, 132, 255, 0.15)', selectionBorderColor: '#0a84ff', selectionLineWidth: 2
        });

        fabric.Object.prototype.set({
            transparentCorners: false, cornerColor: '#ffffff', cornerStrokeColor: '#0a84ff', borderColor: '#0a84ff', cornerSize: 16, padding: 10, cornerStyle: 'circle'
        });

        let currentZoom = 1; let zoomState = 'fit'; let genGradientType = 'linear';
        let canvasHistory = []; let historyIndex = -1; let isHistoryProcessing = false; let historyTimeout;
        let snapToGrid = false; const gridLimit = 20; let clipboard = null;
        
        // Populate Fonts
        const fonts = ["Inter", "Anek Malayalam", "Abril Fatface", "Anton", "Bungee", "Baloo Chettan 2", "Bebas Neue", "Caveat", "Chilanka", "Cinzel", "Dancing Script", "Gayathri", "Impact", "Lato", "Lobster", "Manjari", "Meera Inimai", "Merriweather", "Mina", "Montserrat", "Mukta Malar", "Noto Sans Malayalam", "Noto Serif Malayalam", "Open Sans", "Oswald", "Pacifico", "Permanent Marker", "Playfair Display", "Poppins", "Raleway", "Righteous", "Roboto", "Space Grotesk", "Syne"];
        const fontSelect = document.getElementById('val-font');
        if (fontSelect) {
            fonts.forEach(f => { const opt = document.createElement('option'); opt.value = f; opt.innerText = f; fontSelect.appendChild(opt); });
        }

        // --- Core UI & Helpers ---
        function showToast(msg) {
            const toast = document.getElementById('toast');
            if (toast) {
                document.getElementById('toast-msg').innerText = msg;
                toast.classList.remove('hide'); toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); toast.classList.add('hide'); }, 2500);
            }
        }

        function toggleAccordion(id, btn) {
            const content = document.getElementById(id);
            if (!content) return;
            const icon = btn.querySelector('.fa-chevron-down');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden'); icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden'); icon.classList.remove('rotate-180');
            }
        }
        
        function openClearModal() { document.getElementById('clearModal').classList.add('show'); }
        function closeClearModal() { document.getElementById('clearModal').classList.remove('show'); }

        function openInfoModal() { document.getElementById('infoModal').classList.add('show'); closeAllSheets(); }
        function closeInfoModal() { document.getElementById('infoModal').classList.remove('show'); }

        function downloadAppHTML() {
            closeInfoModal();
            showToast('Packaging App...');
            
            setTimeout(() => {
                // Ensure toast is hidden in the downloaded file so it doesn't stay permanently visible
                const toast = document.getElementById('toast');
                toast.classList.remove('show');
                toast.classList.add('hide');

                const htmlContent = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'StudioPro_Offline.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('App Downloaded!');
            }, 350);
        }

        function executeClearCanvas() {
            canvas.clear();
            canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
            closeClearModal();
            saveHistory();
            showToast('Canvas Cleared');
        }

        // Snap to grid logic
        function toggleSnap() {
            snapToGrid = !snapToGrid;
            showToast(snapToGrid ? 'Snap to Grid: ON' : 'Snap to Grid: OFF');
        }

        canvas.on('object:moving', function(options) {
            if (!snapToGrid) return;
            options.target.set({
                left: Math.round(options.target.left / gridLimit) * gridLimit,
                top: Math.round(options.target.top / gridLimit) * gridLimit
            });
        });

        // --- Keyboard Shortcuts (Pro Features) ---
        window.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            if (e.key === 'Delete' || e.key === 'Backspace') { e.preventDefault(); deleteSelected(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c') { e.preventDefault(); copy(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v') { e.preventDefault(); paste(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') { e.preventDefault(); undo(); }
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') { e.preventDefault(); redo(); }
        });

        function copy() { 
            const obj = canvas.getActiveObject();
            if(obj) { obj.clone(function(cloned) { clipboard = cloned; showToast('Copied'); }); }
        }

        function paste() {
            if (!clipboard) return;
            clipboard.clone(function(clonedObj) {
                canvas.discardActiveObject();
                clonedObj.set({ left: clonedObj.left + 30, top: clonedObj.top + 30, evented: true });
                if (clonedObj.type === 'activeSelection') { 
                    clonedObj.canvas = canvas; clonedObj.forEachObject(function(o) { canvas.add(o); }); clonedObj.setCoords(); 
                } else { canvas.add(clonedObj); }
                clipboard.top += 30; clipboard.left += 30;
                canvas.setActiveObject(clonedObj); canvas.requestRenderAll(); showToast('Pasted');
            });
        }

        // --- History / Undo / Redo Engine (Debounced) ---
        function saveHistory() {
            if (isHistoryProcessing) return;
            const json = canvas.toJSON(['isSmart3D', 'smartProps', 'clipPath', 'customAdjustments', 'selectable', 'lockMovementX', 'lockMovementY', 'lockRotation', 'lockScalingX', 'lockScalingY', 'hasControls']);
            if (historyIndex < canvasHistory.length - 1) canvasHistory = canvasHistory.slice(0, historyIndex + 1);
            canvasHistory.push(json); if (canvasHistory.length > 30) canvasHistory.shift(); else historyIndex++;
            updateHistoryButtons();
        }
        function undo() {
            if (historyIndex > 0) {
                isHistoryProcessing = true; historyIndex--;
                canvas.loadFromJSON(canvasHistory[historyIndex], function() { canvas.renderAll(); isHistoryProcessing = false; updateHistoryButtons(); handleDeselection(); showToast('Undo'); });
            }
        }
        function redo() {
            if (historyIndex < canvasHistory.length - 1) {
                isHistoryProcessing = true; historyIndex++;
                canvas.loadFromJSON(canvasHistory[historyIndex], function() { canvas.renderAll(); isHistoryProcessing = false; updateHistoryButtons(); handleDeselection(); showToast('Redo'); });
            }
        }
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('btn-undo'); const redoBtn = document.getElementById('btn-redo');
            if(undoBtn){ undoBtn.style.opacity = historyIndex > 0 ? '1' : '0.4'; undoBtn.style.cursor = historyIndex > 0 ? 'pointer' : 'not-allowed'; }
            if(redoBtn){ redoBtn.style.opacity = historyIndex < canvasHistory.length - 1 ? '1' : '0.4'; redoBtn.style.cursor = historyIndex < canvasHistory.length - 1 ? 'pointer' : 'not-allowed'; }
        }
        canvas.on('object:added', () => { clearTimeout(historyTimeout); historyTimeout = setTimeout(saveHistory, 150); }); 
        canvas.on('object:modified', () => { clearTimeout(historyTimeout); historyTimeout = setTimeout(saveHistory, 150); }); 
        canvas.on('object:removed', () => { clearTimeout(historyTimeout); historyTimeout = setTimeout(saveHistory, 150); });
        
        // Sync UI text field when typing on canvas directly
        canvas.on('text:changed', function(e) {
            const obj = e.target;
            const valText = document.getElementById('val-text');
            if(valText) valText.value = obj.text;
            clearTimeout(historyTimeout); historyTimeout = setTimeout(saveHistory, 500);
        });

        function init() { document.fonts.ready.then(function() { setTimeout(() => { resetZoom(); saveHistory(); showToast('Studio Ready'); }, 150); }); }

        // --- Viewport, Zoom & Touch Gestures ---
        const workspace = document.getElementById('workspace');
        const wrapper = document.getElementById('canvas-wrapper');
        let pinchZoomStart = 0; let initialZoom = 1;

        function resetZoom() {
            const paddingX = window.innerWidth < 768 ? 20 : 120; const paddingY = window.innerWidth < 768 ? 280 : 300; 
            const scaleX = (workspace.clientWidth - paddingX) / canvas.width; const scaleY = (workspace.clientHeight - paddingY) / canvas.height;
            currentZoom = Math.min(scaleX, scaleY, 1); zoomState = 'fit'; applyZoom();
        }
        
        function cycleZoom() {
            if (zoomState === 'fit') { currentZoom = 1.0; zoomState = '100'; } 
            else if (zoomState === '100') { currentZoom = 1.5; zoomState = '150'; } 
            else { resetZoom(); return; }
            applyZoom();
        }
        
        function applyZoom() {
            if (currentZoom < 0.1) currentZoom = 0.1; if (currentZoom > 4) currentZoom = 4;
            wrapper.style.transform = `scale(${currentZoom})`;
            document.getElementById('zoomBadge').innerText = zoomState === 'fit' ? "FIT" : Math.round(currentZoom * 100) + '%';
        }
        
        window.addEventListener('resize', () => { if(document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') resetZoom(); });

        // Native Pinch-To-Zoom Handler for mobile
        if(workspace) {
            workspace.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    pinchZoomStart = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    initialZoom = currentZoom;
                }
            }, {passive: false});

            workspace.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    const scale = dist / pinchZoomStart;
                    currentZoom = initialZoom * scale;
                    zoomState = 'custom';
                    applyZoom();
                }
            }, {passive: false});
        }

        function toggleFullScreen() {
            if (!document.fullscreenEnabled) {
                showToast("Fullscreen not supported");
                return;
            }
            const doc = window.document, docEl = doc.documentElement;
            const req = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
            const cancel = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
            if(!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                if(req) { 
                    req.call(docEl).then(() => {
                        document.getElementById('fs-icon').className = 'fa-solid fa-compress text-[15px]'; 
                    }).catch(err => {
                        showToast("Fullscreen blocked");
                        console.error(err);
                    });
                }
            } else { 
                if(cancel) { 
                    cancel.call(doc).then(() => {
                        document.getElementById('fs-icon').className = 'fa-solid fa-expand text-[15px]'; 
                    });
                } 
            }
        }

        function setCanvasRatio(ratioType) {
            let w = 1080, h = 1350; // default poster
            if(ratioType === 'square') { w = 1080; h = 1080; }
            else if(ratioType === 'story') { w = 1080; h = 1920; }
            else if(ratioType === 'landscape') { w = 1920; h = 1080; }
            else if(ratioType === 'youtube') { w = 1280; h = 720; }
            else if(ratioType === 'twitter') { w = 1200; h = 675; }
            else if(ratioType === 'fbCover') { w = 1640; h = 856; }
            else if(ratioType === 'linkedin') { w = 1200; h = 627; }
            else if(ratioType === 'photo') { w = 1200; h = 900; }
            else if(ratioType === 'a4') { w = 1240; h = 1754; }
            canvas.setWidth(w); canvas.setHeight(h); resetZoom(); closeAllSheets(); showToast(`Canvas Resized`);
        }

        // --- File Uploaders (Images & Backgrounds) ---
        document.getElementById('imageLoader').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    if(img.width > canvas.width) img.scaleToWidth(canvas.width * 0.8);
                    img.set({ left: canvas.width/2, top: canvas.height/2, originX: 'center', originY: 'center' });
                    canvas.add(img); canvas.setActiveObject(img);
                    closeAllSheets(); showToast('Image Added');
                });
            }; reader.readAsDataURL(file); e.target.value = '';
        });

        document.getElementById('bgImageUploader').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(f) {
                fabric.Image.fromURL(f.target.result, function(img) {
                    const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                    img.set({ originX: 'center', originY: 'center', left: canvas.width/2, top: canvas.height/2, scaleX: scale, scaleY: scale });
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    closeAllSheets(); showToast('Background Image Set'); saveHistory();
                });
            }; reader.readAsDataURL(file); e.target.value = '';
        });

        function addQRCode() {
            const data = prompt("Enter URL or text for QR Code:", "https://example.com");
            if(!data) return;
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data)}`;
            fabric.Image.fromURL(url, function(img) {
                img.set({ left: canvas.width/2, top: canvas.height/2, originX: 'center', originY: 'center' });
                canvas.add(img); canvas.setActiveObject(img);
                closeAllSheets(); showToast('QR Code Added');
            }, { crossOrigin: 'anonymous' });
        }

        // --- UI Panels & Swipe Gestures ---
        function toggleSheet(sheetId) {
            const sheet = document.getElementById(sheetId); const isOpen = sheet.classList.contains('open');
            closeAllSheets(); if (!isOpen) { sheet.classList.add('open'); updateNavIcons(sheetId); }
        }
        function closeAllSheets() { document.querySelectorAll('.sheet').forEach(s => { s.classList.remove('open'); s.style.transform = ''; }); document.querySelectorAll('.dock-icon').forEach(b => b.classList.remove('active')); }
        function updateNavIcons(activeId) {
            if(activeId === 'addSheet') document.getElementById('nav-add').classList.add('active');
            if(activeId === 'editSheet') document.getElementById('nav-edit').classList.add('active');
            if(activeId === 'bgSheet') document.getElementById('nav-bg').classList.add('active');
        }
        
        // Advanced Swipe-to-close mechanism (entire drag area)
        document.querySelectorAll('.sheet-drag-area').forEach(grabber => {
            let startY = 0; let currentY = 0; let isDragging = false;
            
            grabber.addEventListener('touchstart', e => { 
                startY = e.touches[0].clientY; currentY = startY; isDragging = true;
                grabber.parentElement.style.transition = 'none'; 
            }, {passive: true});
            
            grabber.addEventListener('touchmove', e => {
                if(!isDragging) return;
                currentY = e.touches[0].clientY;
                let delta = currentY - startY;
                if(delta > 0) { grabber.parentElement.style.transform = `translateY(${delta}px)`; }
            }, {passive: true});
            
            grabber.addEventListener('touchend', e => {
                if(!isDragging) return;
                isDragging = false;
                let delta = currentY - startY;
                grabber.parentElement.style.transition = 'transform 0.4s var(--apple-spring)';
                if(delta > 60) closeAllSheets(); else grabber.parentElement.style.transform = 'translateY(0)';
            });
            // Click on handle area also toggles close for mouse users
            grabber.addEventListener('click', closeAllSheets);
        });
        
        // --- Contextual Selection UI & Layer Management ---
        canvas.on('selection:created', handleSelection); canvas.on('selection:updated', handleSelection); canvas.on('selection:cleared', handleDeselection);
        canvas.on('mouse:down', function(e) { if (!e.target && !isDrawingMode) closeAllSheets(); });

        function bringForward() { const obj = canvas.getActiveObject(); if(obj) { canvas.bringForward(obj); canvas.requestRenderAll(); saveHistory(); } }
        function sendBackward() { const obj = canvas.getActiveObject(); if(obj) { canvas.sendBackward(obj); canvas.requestRenderAll(); saveHistory(); } }
        function bringToFront() { const obj = canvas.getActiveObject(); if(obj) { canvas.bringToFront(obj); canvas.requestRenderAll(); saveHistory(); } }
        function sendToBack() { const obj = canvas.getActiveObject(); if(obj) { canvas.sendToBack(obj); canvas.requestRenderAll(); saveHistory(); } }
        
        function duplicateSelected() {
            const obj = canvas.getActiveObject(); if (!obj) return;
            obj.clone(function(cloned) {
                cloned.set({ left: obj.left + 20, top: obj.top + 20, evented: true });
                if (cloned.type === 'activeSelection') { cloned.canvas = canvas; cloned.forEachObject(function(o) { canvas.add(o); }); cloned.setCoords(); } else { canvas.add(cloned); }
                canvas.setActiveObject(cloned); canvas.requestRenderAll(); showToast('Duplicated');
            });
        }
        function deleteSelected() {
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length) {
                canvas.discardActiveObject(); 
                activeObjects.forEach(function(o) { canvas.remove(o); }); 
                canvas.requestRenderAll();
                showToast('Deleted');
                handleDeselection();
            }
        }
        function toggleLock() {
            const obj = canvas.getActiveObject(); if (!obj) return;
            const isLocked = obj.lockMovementX;
            obj.set({ selectable: isLocked, evented: isLocked, lockMovementX: !isLocked, lockMovementY: !isLocked, lockRotation: !isLocked, lockScalingX: !isLocked, lockScalingY: !isLocked, hasControls: isLocked });
            canvas.discardActiveObject(); canvas.requestRenderAll(); showToast(isLocked ? 'Unlocked' : 'Locked');
        }

        // New Group & Ungroup
        function groupSelected() {
            if (!canvas.getActiveObject()) return;
            if (canvas.getActiveObject().type !== 'activeSelection') return;
            canvas.getActiveObject().toGroup();
            canvas.requestRenderAll();
            saveHistory();
            showToast('Objects Grouped');
            handleSelection();
        }

        function ungroupSelected() {
            if (!canvas.getActiveObject()) return;
            if (canvas.getActiveObject().type !== 'group') return;
            if (canvas.getActiveObject().isSmart3D) return; // Prevent ungrouping generated 3D elements
            canvas.getActiveObject().toActiveSelection();
            canvas.requestRenderAll();
            saveHistory();
            showToast('Objects Ungrouped');
            handleSelection();
        }

        function handleSelection() {
            const obj = canvas.getActiveObject(); if (!obj) return;
            document.getElementById('editEmpty').style.display = 'none'; document.getElementById('editContent').style.display = 'flex';
            if (!document.getElementById('editSheet').classList.contains('open') && window.innerWidth < 768) toggleSheet('editSheet');
            buildEditTabs(obj); populateProperties(obj);
        }
        function handleDeselection() { 
            document.getElementById('editEmpty').style.display = 'flex'; 
            document.getElementById('editContent').style.display = 'none'; 
            closeAllSheets(); 
        }

        function buildEditTabs(obj) {
            const tc = document.getElementById('editTabs'); tc.innerHTML = ''; const tabs = []; const isMulti = obj.type === 'activeSelection';
            
            // Contextual Group Buttons
            document.getElementById('btn-group').style.display = isMulti ? 'flex' : 'none';
            document.getElementById('btn-ungroup').style.display = (!isMulti && obj.type === 'group' && !obj.isSmart3D) ? 'flex' : 'none';

            if (obj.isSmart3D) { tabs.push({ id: 'text', icon: 'fa-font', label: '3D Text' }, { id: 'style', icon: 'fa-palette', label: '3D Style' }); } 
            else {
                if (!isMulti && ['text', 'textbox', 'i-text'].includes(obj.type)) tabs.push({ id: 'text', icon: 'fa-font', label: 'Text' });
                if (!isMulti && obj.type !== 'image' && obj.type !== 'group') tabs.push({ id: 'style', icon: 'fa-palette', label: 'Style' });
                if (!isMulti && obj.type === 'image') tabs.push({ id: 'image', icon: 'fa-image', label: 'Adjust' }, { id: 'style', icon: 'fa-droplet', label: 'Opacity' });
                if (!isMulti && obj.type !== 'group') tabs.push({ id: 'effects', icon: 'fa-moon', label: 'Shadows' });
            }
            if(tabs.length === 0 && isMulti) {
                tc.innerHTML = '<span class="text-xs font-semibold text-white/60 px-3 py-2">Multiple Selection. Edit layers above.</span>';
                document.querySelectorAll('.prop-section').forEach(s => s.classList.remove('active'));
            } else {
                tabs.forEach((t, i) => {
                    const btn = document.createElement('button');
                    btn.className = `btn-press px-5 py-2 text-xs font-bold rounded-xl transition flex items-center gap-2 ${i===0 ? 'bg-ios-blue text-white shadow-lg shadow-ios-blue/30' : 'text-white/60 hover:text-white hover:bg-white/10'}`;
                    btn.innerHTML = `<i class="fa-solid ${t.icon} text-sm"></i> ${t.label}`; btn.onclick = () => switchPropSection(t.id, btn); tc.appendChild(btn);
                    if(i===0) switchPropSection(t.id, btn); 
                });
            }
            const lockBtn = document.getElementById('lockBtn');
            if (obj.selectable === false || obj.lockMovementX) { lockBtn.innerHTML = '<i class="fa-solid fa-lock text-red-400 text-sm"></i>'; } else { lockBtn.innerHTML = '<i class="fa-solid fa-lock-open text-sm"></i>'; }
        }

        function switchPropSection(id, btnEl) {
            document.querySelectorAll('.prop-section').forEach(s => s.classList.remove('active'));
            if(document.getElementById('sec-' + id)) document.getElementById('sec-' + id).classList.add('active');
            for(let tab of document.getElementById('editTabs').children) tab.className = 'btn-press px-5 py-2 text-xs font-bold rounded-xl transition flex items-center gap-2 text-white/60 hover:text-white hover:bg-white/10';
            btnEl.className = 'btn-press px-5 py-2 text-xs font-bold rounded-xl transition flex items-center gap-2 bg-ios-blue text-white shadow-lg shadow-ios-blue/30';
        }

        function populateProperties(obj) {
            if(obj.type === 'activeSelection') return;
            document.getElementById('wrap-fill').style.display = (obj.isSmart3D || obj.type === 'image') ? 'none' : 'flex';
            document.getElementById('wrap-stroke').style.display = (obj.isSmart3D || obj.type === 'image') ? 'none' : 'block';
            document.getElementById('wrap-3d-colors').style.display = obj.isSmart3D ? 'flex' : 'none';
            document.getElementById('wrap-radius').style.display = obj.type === 'rect' ? 'block' : 'none';

            if (obj.isSmart3D) {
                document.getElementById('val-text').value = obj.smartProps.text; document.getElementById('val-font').value = obj.smartProps.fontFamily;
                document.getElementById('val-fontsize').value = obj.smartProps.fontSize; document.getElementById('val-3d-face').value = rHex(obj.smartProps.faceColor);
                document.getElementById('val-3d-ext').value = rHex(obj.smartProps.extColor); document.getElementById('val-3d-depth').value = obj.smartProps.depth;
                updateAlignUI(obj.smartProps.textAlign || 'center');
            } else {
                if (obj.text !== undefined) {
                    const valText = document.getElementById('val-text');
                    if (valText) valText.value = obj.text;
                    document.getElementById('val-font').value = obj.fontFamily || 'Poppins';
                    document.getElementById('val-fontsize').value = obj.fontSize; document.getElementById('val-lineheight').value = obj.lineHeight || 1.16;
                    document.getElementById('val-letterspace').value = obj.charSpacing || 0;
                    document.getElementById('val-weight').value = obj.fontWeight || 'normal'; updateAlignUI(obj.textAlign || 'left');
                }
                document.getElementById('val-opacity').value = obj.opacity !== undefined ? obj.opacity : 1;
                if (obj.fill && typeof obj.fill === 'string') { document.getElementById('val-fill').value = rHex(obj.fill); document.getElementById('val-fill-hex').value = rHex(obj.fill); }
                document.getElementById('val-stroke-color').value = rHex(obj.stroke); document.getElementById('val-stroke-width').value = obj.strokeWidth || 0;
                if(obj.type === 'rect') document.getElementById('val-radius').value = obj.rx || 0;

                if (obj.shadow) {
                    document.getElementById('val-shadow-color').value = rHex(obj.shadow.color); document.getElementById('val-shadow-blur').value = obj.shadow.blur || 0;
                    document.getElementById('val-shadow-offsetx').value = obj.shadow.offsetX || 0; document.getElementById('val-shadow-offsety').value = obj.shadow.offsetY || 0;
                } else { document.getElementById('val-shadow-blur').value = 0; document.getElementById('val-shadow-offsetx').value = 0; document.getElementById('val-shadow-offsety').value = 0; }
                
                if (obj.type === 'image') {
                    const adj = obj.customAdjustments || { b:0, c:0, s:0, blur: 0, effect: 'none' };
                    document.getElementById('val-img-brightness').value = adj.b; document.getElementById('val-img-contrast').value = adj.c; document.getElementById('val-img-saturation').value = adj.s; document.getElementById('val-img-blur').value = adj.blur || 0;
                }
            }
        }
        function updateAlignUI(align) { ['left','center','right'].forEach(a => document.getElementById('align-'+a).classList.remove('active')); if(document.getElementById('align-'+align)) document.getElementById('align-'+align).classList.add('active'); }

        // --- Core Editing & Drawing ---
        let isDrawingMode = false;
        function toggleDrawMode() {
            isDrawingMode = !isDrawingMode;
            canvas.isDrawingMode = isDrawingMode;
            const btn = document.getElementById('drawModeBtn');
            const settings = document.getElementById('drawSettings');
            if(isDrawingMode) {
                btn.classList.add('bg-ios-blue/30', 'border-ios-blue');
                settings.classList.remove('hidden');
                updateBrush();
            } else {
                btn.classList.remove('bg-ios-blue/30', 'border-ios-blue');
                settings.classList.add('hidden');
            }
        }
        function updateBrush() {
            canvas.freeDrawingBrush.color = document.getElementById('brushColor').value;
            canvas.freeDrawingBrush.width = parseInt(document.getElementById('brushSize').value, 10) || 10;
        }

        function updateProp(key, value) {
            const obj = canvas.getActiveObject(); if (!obj) return;
            if (key === 'fill' && typeof value === 'string') document.getElementById('val-fill-hex').value = value;
            if (obj.isSmart3D) { if(['text', 'fontFamily', 'fontSize', 'textAlign'].includes(key)) update3DProp(key, value); } 
            else { 
                obj.set(key, value); 
                canvas.requestRenderAll(); 
                // Await custom font loading before confirming render
                if (key === 'fontFamily' && document.fonts) {
                    document.fonts.load(`16px "${value}"`).then(() => { canvas.requestRenderAll(); });
                }
            }
        }
        function updateRadius(val) { updateProp('rx', parseInt(val)); updateProp('ry', parseInt(val)); }
        function updateTextAlign(align) { updateAlignUI(align); updateProp('textAlign', align); }
        function updateShadow() {
            const obj = canvas.getActiveObject(); if (!obj) return;
            const blur = parseInt(document.getElementById('val-shadow-blur').value)||0, offsetX = parseInt(document.getElementById('val-shadow-offsetx').value)||0, offsetY = parseInt(document.getElementById('val-shadow-offsety').value)||0;
            obj.set('shadow', (blur===0&&offsetX===0&&offsetY===0)?null:new fabric.Shadow({color:document.getElementById('val-shadow-color').value,blur:blur,offsetX:offsetX,offsetY:offsetY})); canvas.requestRenderAll();
        }
        function rHex(colorStr) {
            if(!colorStr) return '#000000'; if(colorStr.startsWith('#')) return colorStr.length === 4 ? '#' + colorStr[1]+colorStr[1]+colorStr[2]+colorStr[2]+colorStr[3]+colorStr[3] : colorStr.substring(0,7);
            if(colorStr.startsWith('rgb')) { const v = colorStr.match(/\d+(\.\d+)?/g); if(v && v.length >= 3) return `#${parseInt(v[0]).toString(16).padStart(2, '0')}${parseInt(v[1]).toString(16).padStart(2, '0')}${parseInt(v[2]).toString(16).padStart(2, '0')}`; }
            return '#000000'; 
        }

        // --- Pro Alignment & Transforms ---
        function alignObject(pos) {
            const obj = canvas.getActiveObject(); if (!obj) return;
            const w = canvas.width; const h = canvas.height;
            const bound = obj.getBoundingRect(); 
            
            if (pos === 'left') obj.set({ left: obj.left - bound.left });
            if (pos === 'centerH') obj.set({ left: obj.left + (w/2 - (bound.left + bound.width/2)) });
            if (pos === 'right') obj.set({ left: obj.left + (w - (bound.left + bound.width)) });
            if (pos === 'top') obj.set({ top: obj.top - bound.top });
            if (pos === 'centerV') obj.set({ top: obj.top + (h/2 - (bound.top + bound.height/2)) });
            if (pos === 'bottom') obj.set({ top: obj.top + (h - (bound.top + bound.height)) });
            
            canvas.requestRenderAll(); clearTimeout(historyTimeout); historyTimeout = setTimeout(saveHistory, 150);
        }

        function flipObj(axis) {
            const obj = canvas.getActiveObject(); if (!obj) return;
            if(axis === 'x') obj.set('flipX', !obj.flipX);
            if(axis === 'y') obj.set('flipY', !obj.flipY);
            canvas.requestRenderAll(); saveHistory();
        }

        // --- PRO IMAGE EDITOR (Optimized for Mobile) ---
        function updateImageSliders() {
            const obj = canvas.getActiveObject(); if(!obj || obj.type !== 'image') return;
            if(!obj.customAdjustments) obj.customAdjustments = { b:0, c:0, s:0, blur:0, effect: 'none' };
            obj.customAdjustments.b = parseFloat(document.getElementById('val-img-brightness').value); obj.customAdjustments.c = parseFloat(document.getElementById('val-img-contrast').value); obj.customAdjustments.s = parseFloat(document.getElementById('val-img-saturation').value); obj.customAdjustments.blur = parseFloat(document.getElementById('val-img-blur').value);
            applyImageEngine(obj);
        }
        function applyImageEffect(effectType) {
            const obj = canvas.getActiveObject(); if(!obj || obj.type !== 'image') return;
            if(!obj.customAdjustments) obj.customAdjustments = { b:0, c:0, s:0, blur:0, effect: 'none' };
            obj.customAdjustments.effect = effectType; applyImageEngine(obj); clearTimeout(historyTimeout); historyTimeout = setTimeout(saveHistory, 150);
        }
        function applyImageEngine(obj) {
            const adj = obj.customAdjustments; obj.filters = [];
            if (adj.b !== 0) obj.filters.push(new fabric.Image.filters.Brightness({ brightness: adj.b }));
            if (adj.c !== 0) obj.filters.push(new fabric.Image.filters.Contrast({ contrast: adj.c }));
            if (adj.s !== 0) obj.filters.push(new fabric.Image.filters.Saturation({ saturation: adj.s }));
            if (adj.blur !== 0) obj.filters.push(new fabric.Image.filters.Blur({ blur: adj.blur }));
            if (adj.effect === 'grayscale') obj.filters.push(new fabric.Image.filters.Grayscale()); else if (adj.effect === 'sepia') obj.filters.push(new fabric.Image.filters.Sepia()); else if (adj.effect === 'invert') obj.filters.push(new fabric.Image.filters.Invert());
            obj.applyFilters(); canvas.requestRenderAll();
        }
        function setImageCrop(shape) {
            const obj = canvas.getActiveObject(); if(!obj || obj.type !== 'image') return;
            if (shape === 'square') { obj.set('clipPath', null); }
            else if (shape === 'rounded') { obj.set('clipPath', new fabric.Rect({ width: obj.width, height: obj.height, rx: obj.width*0.1, ry: obj.width*0.1, originX: 'center', originY: 'center', left: 0, top: 0 })); }
            else if (shape === 'circle') { obj.set('clipPath', new fabric.Circle({ radius: Math.min(obj.width, obj.height)/2, originX: 'center', originY: 'center', left: 0, top: 0 })); }
            canvas.requestRenderAll(); clearTimeout(historyTimeout); historyTimeout = setTimeout(saveHistory, 150);
        }

        // --- FLAWLESS SMART 3D ENGINE ---
        function add3DText(type) {
            const props = { text: type === 'ENGLISH' ? "EPIC TITLE" : "", fontFamily: type === 'ENGLISH' ? "Anton" : "Anek Malayalam", fontSize: 160, fontWeight: 'bold', textAlign: 'center', faceColor: type === 'ENGLISH' ? "#eab308" : "#facc15", extColor: type === 'ENGLISH' ? "#78350f" : "#b45309", depth: 15 };
            const group = gen3D(props); group.set({ left: canvas.width/2, top: canvas.height/2 }); canvas.add(group); canvas.setActiveObject(group); closeAllSheets();
        }
        function gen3D(props) {
            const { text, fontFamily, fontSize, fontWeight, textAlign, faceColor, extColor, depth } = props; const items = [];
            items.push(new fabric.Text(text, { fontFamily, fontSize, fontWeight, textAlign, fill: 'rgba(0,0,0,0.6)', originX: 'center', originY: 'center', left: depth + 12, top: depth + 12 }));
            for(let i = depth; i > 0; i--) { items.push(new fabric.Text(text, { fontFamily, fontSize, fontWeight, textAlign, fill: extColor, originX: 'center', originY: 'center', left: i, top: i, stroke: '#000000', strokeWidth: 5, strokeLineJoin: 'round', paintFirst: 'stroke' })); }
            items.push(new fabric.Text(text, { fontFamily, fontSize, fontWeight, textAlign, fill: faceColor, originX: 'center', originY: 'center', left: 0, top: 0, stroke: '#000000', strokeWidth: fontSize > 100 ? 3 : 1, strokeLineJoin: 'round', paintFirst: 'stroke' }));
            const group = new fabric.Group(items, { originX: 'center', originY: 'center' }); group.isSmart3D = true; group.smartProps = { ...props }; return group;
        }
        function update3DProp(key, value) {
            const obj = canvas.getActiveObject(); if(!obj || !obj.isSmart3D) return;
            const state = { left: obj.left, top: obj.top, scaleX: obj.scaleX, scaleY: obj.scaleY, angle: obj.angle };
            obj.smartProps[key] = value; const newGroup = gen3D(obj.smartProps); newGroup.set(state);
            isHistoryProcessing = true; canvas.remove(obj); canvas.add(newGroup); canvas.setActiveObject(newGroup); isHistoryProcessing = false;
        }

        // --- ADD/INSERT HELPERS (Artifacts, Shapes, Icons, Presets) ---
        function centerAndAdd(obj) {
            obj.set({ left: canvas.width / 2, top: canvas.height / 2, originX: 'center', originY: 'center' });
            canvas.add(obj);
            canvas.setActiveObject(obj);
            closeAllSheets();
            saveHistory();
        }

        function addEmoji(emoji) {
            centerAndAdd(new fabric.Text(emoji, { fontSize: 100 }));
        }

        function addIcon(code, color, style) {
            const fontFamily = style === 'brand' ? '"Font Awesome 6 Brands"' : '"Font Awesome 6 Free"';
            const fontWeight = style === 'solid' ? 900 : 400;
            centerAndAdd(new fabric.Text(code, { fontFamily, fontWeight, fill: color, fontSize: 80 }));
        }

        function addTextPreset(type) {
            let text = "NEW TEXT";
            let opts = { fontSize: 80, fill: '#ffffff', fontFamily: 'Inter' };

            if (type === 'heading') { opts.fontWeight = 'bold'; }
            else if (type === 'malayalam') { text = ""; opts.fontFamily = "Anek Malayalam"; opts.fontWeight = 'bold'; opts.fontSize = 100; }
            else if (type === 'neon') { opts.fontFamily = 'Righteous'; opts.fill = '#ffffff'; opts.shadow = new fabric.Shadow({ color: '#06b6d4', blur: 20, offsetX: 0, offsetY: 0 }); }
            else if (type === 'outline') { opts.fontFamily = 'Anton'; opts.fill = 'transparent'; opts.stroke = '#ffffff'; opts.strokeWidth = 2; opts.fontSize = 120; text = "OUTLINE"; }
            else if (type === 'vintage') { opts.fontFamily = 'Playfair Display'; opts.fontStyle = 'italic'; opts.fill = '#fed7aa'; }
            else if (type === 'glitch') { opts.fontFamily = 'Space Grotesk'; opts.fontWeight = 'bold'; opts.fill = '#fecaca'; opts.shadow = new fabric.Shadow({ color: '#ef4444', blur: 2, offsetX: 4, offsetY: 0 }); }

            centerAndAdd(new fabric.Text(text, opts));
        }

        function addShape(type) {
            let obj;
            const fill = '#e2e8f0';
            if (type === 'rect') obj = new fabric.Rect({ width: 150, height: 150, fill, rx: 16, ry: 16 });
            else if (type === 'circle') obj = new fabric.Circle({ radius: 75, fill });
            else if (type === 'triangle') obj = new fabric.Triangle({ width: 150, height: 150, fill });
            else if (type === 'line') obj = new fabric.Line([0,0,200,0], { stroke: fill, strokeWidth: 10 });
            else if (type === 'frame') obj = new fabric.Rect({ width: 200, height: 200, fill: 'transparent', stroke: fill, strokeWidth: 10 });
            else {
                // Polygon generation for standard shapes
                let points = [];
                const r = 75;
                let sides = 6;
                if (type === 'diamond') { sides = 4; }
                if (type === 'pentagon') sides = 5;
                if (type === 'octagon') sides = 8;
                if (type === 'star') {
                    // Star shape
                    for (let i = 0; i < 10; i++) {
                        let rad = i % 2 === 0 ? r : r / 2;
                        points.push({ x: rad * Math.sin(i * Math.PI / 5), y: rad * -Math.cos(i * Math.PI / 5) });
                    }
                    obj = new fabric.Polygon(points, { fill });
                } else if (['hexagon', 'diamond', 'pentagon', 'octagon'].includes(type)) {
                    for (let i = 0; i < sides; i++) {
                        points.push({ x: r * Math.sin(i * 2 * Math.PI / sides), y: r * -Math.cos(i * 2 * Math.PI / sides) });
                    }
                    obj = new fabric.Polygon(points, { fill });
                } else if (type === 'cross') {
                    obj = new fabric.Group([
                        new fabric.Rect({ width: 150, height: 40, fill, originX: 'center', originY: 'center', rx: 10 }),
                        new fabric.Rect({ width: 40, height: 150, fill, originX: 'center', originY: 'center', rx: 10 })
                    ]);
                } else {
                    obj = new fabric.Rect({ width: 100, height: 100, fill, rx: 20 });
                }
            }
            if(obj) centerAndAdd(obj);
        }

        function addElement(type) { addShape('circle'); }
        
        function addArtifact(type) {
            // Simplified dynamic group generation based on type
            const bg = new fabric.Rect({ width: 350, height: 120, fill: '#1e293b', rx: 20, originX: 'center', originY: 'center', shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.5)', blur: 15, offsetY: 10 }) });
            const title = new fabric.Text(type.toUpperCase().replace(/([A-Z])/g, ' $1').trim(), { fill: '#ffffff', fontSize: 30, fontWeight: 'bold', fontFamily: 'Inter', originX: 'center', originY: 'center', top: -15 });
            const subtitle = new fabric.Text("Double tap to edit layer", { fill: '#94a3b8', fontSize: 14, fontFamily: 'Inter', originX: 'center', originY: 'center', top: 20 });
            
            if(type.includes('neon') || type.includes('Glitch')) { bg.set({ fill: 'transparent', stroke: '#fff', strokeWidth: 4 }); }
            
            const group = new fabric.Group([bg, title, subtitle]);
            centerAndAdd(group);
        }

        // --- Backgrounds & Patterns ---
        function setBgColor(color) { canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas)); canvas.setBackgroundColor(color, canvas.renderAll.bind(canvas)); closeAllSheets(); saveHistory(); showToast('Background Color Set'); }
        function setBgGrad(type, c1, c2, angle = 135, skipHistory = false) {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas)); const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2; let grad;
            if(type === 'linear') { const angleRad = (angle - 90) * (Math.PI / 180); const r = Math.sqrt(w*w + h*h) / 2; grad = new fabric.Gradient({ type: 'linear', coords: { x1: cx - Math.cos(angleRad)*r, y1: cy - Math.sin(angleRad)*r, x2: cx + Math.cos(angleRad)*r, y2: cy + Math.sin(angleRad)*r }, colorStops: [{offset: 0, color: c1}, {offset: 1, color: c2}] }); }
            else { grad = new fabric.Gradient({ type: 'radial', coords: { r1: 0, r2: Math.max(w,h), x1: cx, y1: cy, x2: cx, y2: cy }, colorStops: [{offset: 0, color: c1}, {offset: 1, color: c2}] }); }
            canvas.setBackgroundColor(grad, canvas.renderAll.bind(canvas));
            if(!skipHistory) { saveHistory(); showToast('Gradient Applied'); }
        }
        function setGenType(type) { genGradientType = type; document.getElementById('btn-linear').classList.toggle('active', type === 'linear'); document.getElementById('btn-radial').classList.toggle('active', type === 'radial'); applyCustomGradient(); }
        function applyCustomGradient() { setBgGrad(genGradientType, document.getElementById('gen-col1').value, document.getElementById('gen-col2').value, parseInt(document.getElementById('gen-angle').value)); }
        
        // --- Premium Background Generators (NEW) ---
        function applyPresetBg(id) {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas));
            const w = canvas.width, h = canvas.height;
            let c1, c2, type = 'linear';
            
            switch(id) {
                case 'sunset': c1 = '#ff7e5f'; c2 = '#feb47b'; break;
                case 'ocean': c1 = '#2b5876'; c2 = '#4e4376'; break;
                case 'aurora': c1 = '#00c6ff'; c2 = '#0072ff'; break;
                case 'cyber': c1 = '#f80759'; c2 = '#bc4e9c'; break;
                case 'midnight': c1 = '#232526'; c2 = '#414345'; break;
                case 'peach': c1 = '#ed4264'; c2 = '#ffedbc'; type = 'radial'; break;
                case 'lush': c1 = '#56ab2f'; c2 = '#a8e063'; break;
                case 'rose': c1 = '#ff9a9e'; c2 = '#fecfef'; break;
            }

            let grad;
            if (id === 'gold') {
                 grad = new fabric.Gradient({
                    type: 'linear', coords: { x1: 0, y1: 0, x2: w, y2: h },
                    colorStops: [{offset: 0, color: '#bf953f'}, {offset: 0.25, color: '#fcf6ba'}, {offset: 0.5, color: '#b38728'}, {offset: 0.75, color: '#fbf5b7'}, {offset: 1, color: '#aa771c'}]
                });
            } else {
                if(type === 'linear') {
                    grad = new fabric.Gradient({
                        type: 'linear', coords: { x1: 0, y1: 0, x2: w, y2: h },
                        colorStops: [{offset: 0, color: c1}, {offset: 1, color: c2}]
                    });
                } else {
                    const r = Math.sqrt(w*w + h*h) / 2;
                    grad = new fabric.Gradient({
                        type: 'radial', coords: { r1: 0, r2: r, x1: w/2, y1: h/2, x2: w/2, y2: h/2 },
                        colorStops: [{offset: 0, color: c1}, {offset: 1, color: c2}]
                    });
                }
            }
            canvas.setBackgroundColor(grad, canvas.renderAll.bind(canvas));
            closeAllSheets(); saveHistory(); showToast('Preset Applied');
        }

        function generateMeshBg(c1, c2, c3, c4) {
            closeAllSheets(); showToast('Generating Aura...');
            setTimeout(() => {
                const offCanvas = document.createElement('canvas');
                // Use a high-res square dimension for best blurring aspect ratio regardless of canvas shape
                offCanvas.width = 1200; 
                offCanvas.height = 1200; 
                const ctx = offCanvas.getContext('2d');
                
                ctx.fillStyle = c1;
                ctx.fillRect(0, 0, offCanvas.width, offCanvas.height);
                
                // Super heavy blur for the glass/mesh effect
                ctx.filter = 'blur(140px)';
                
                ctx.fillStyle = c2;
                ctx.beginPath(); ctx.arc(900, 250, 450, 0, Math.PI * 2); ctx.fill();

                ctx.fillStyle = c3;
                ctx.beginPath(); ctx.arc(250, 900, 550, 0, Math.PI * 2); ctx.fill();

                ctx.fillStyle = c4;
                ctx.beginPath(); ctx.arc(600, 600, 350, 0, Math.PI * 2); ctx.fill();

                fabric.Image.fromURL(offCanvas.toDataURL('image/jpeg', 0.9), function(img) {
                    const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                    img.set({ originX: 'center', originY: 'center', left: canvas.width/2, top: canvas.height/2, scaleX: scale, scaleY: scale });
                    canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    showToast('Aura Mesh Applied'); saveHistory();
                });
            }, 50);
        }

        function setBgPattern(type) {
            canvas.setBackgroundImage(null, canvas.renderAll.bind(canvas)); const patternCanvas = document.createElement('canvas'); const ctx = patternCanvas.getContext('2d');
            patternCanvas.width = 40; patternCanvas.height = 40; ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, 40, 40); ctx.strokeStyle = 'rgba(0,0,0,0.15)'; ctx.lineWidth = 1;
            if (type === 'grid') { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(40,0); ctx.lineTo(40,40); ctx.lineTo(0,40); ctx.closePath(); ctx.stroke(); } 
            else if (type === 'dots') { ctx.fillStyle = 'rgba(0,0,0,0.2)'; ctx.beginPath(); ctx.arc(20, 20, 2, 0, Math.PI*2); ctx.fill(); } 
            else if (type === 'lines') { ctx.beginPath(); ctx.moveTo(0,40); ctx.lineTo(40,0); ctx.stroke(); }
            else if (type === 'crosshatch') { ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(40,40); ctx.moveTo(40,0); ctx.lineTo(0,40); ctx.stroke(); }
            else if (type === 'plus') { ctx.beginPath(); ctx.moveTo(20,10); ctx.lineTo(20,30); ctx.moveTo(10,20); ctx.lineTo(30,20); ctx.stroke(); }
            const pattern = new fabric.Pattern({ source: patternCanvas, repeat: 'repeat' });
            canvas.setBackgroundColor(pattern, canvas.renderAll.bind(canvas)); saveHistory(); closeAllSheets(); showToast('Pattern Applied');
        }

        // --- Export / Projects ---
        function executeExport(format, multiplier) {
            closeAllSheets(); canvas.discardActiveObject(); canvas.requestRenderAll(); showToast('Generating File...');
            setTimeout(() => {
                const dataURL = canvas.toDataURL({ format: format, quality: 1, multiplier: multiplier }); 
                const link = document.createElement('a'); link.download = `Studio-Pro-${Date.now()}.${format}`; link.href = dataURL; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast('Export Complete');
            }, 300);
        }

        function exportProject() {
            closeAllSheets(); const json = JSON.stringify(canvas.toJSON(['isSmart3D', 'smartProps', 'clipPath', 'customAdjustments', 'selectable', 'lockMovementX', 'lockMovementY', 'lockRotation', 'lockScalingX', 'lockScalingY', 'hasControls']));
            const blob = new Blob([json], {type: "application/json"}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `Studio-Project-${Date.now()}.json`; link.click(); showToast('Project Saved');
        }

        function importProject(e) {
            const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(f) { isHistoryProcessing = true; canvas.loadFromJSON(f.target.result, function() { canvas.renderAll(); isHistoryProcessing = false; saveHistory(); closeAllSheets(); showToast('Project Loaded'); }); };
            reader.readAsText(file); e.target.value = '';
        }

        window.onload = init;
    </script>

</body></html>
